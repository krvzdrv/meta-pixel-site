<script>
/************************************************
 * ðŸŸ¦ META PIXEL + FACEBOOK/INSTAGRAM SHOPS
 * v16.2 â€” FBQ INTERCEPTOR: Fix Tilda's wrong content_ids
 * 
 * ÐšÐ Ð˜Ð¢Ð˜Ð§Ð•Ð¡ÐšÐžÐ• Ð˜Ð¡ÐŸÐ ÐÐ’Ð›Ð•ÐÐ˜Ð•:
 * Tilda Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÑ‚ AddToCart Ñ Tilda UID Ð²Ð¼ÐµÑÑ‚Ð¾ External ID
 * Tilda ÐÐ• Ð³ÐµÐ½ÐµÑ€Ð¸Ñ€ÑƒÐµÑ‚ ÑÐ¾Ð±Ñ‹Ñ‚Ð¸Ðµ tstore-cart-add
 * Ð ÐµÑˆÐµÐ½Ð¸Ðµ: ÐŸÐµÑ€ÐµÑ…Ð²Ð°Ñ‚Ñ‹Ð²Ð°ÐµÐ¼ fbq Ð¸ Ð¸ÑÐ¿Ñ€Ð°Ð²Ð»ÑÐµÐ¼ content_ids Ð½Ð° Ð»ÐµÑ‚Ñƒ
 * 
 * Ð¡Ð°Ð¹Ñ‚: alumineu.ro | Ð’Ð°Ð»ÑŽÑ‚Ð°: RON
 * Pixel ID Ð±ÐµÑ€Ñ‘Ñ‚ÑÑ Ð¸Ð· Tilda â†’ Site Settings â†’ Analytics â†’ Facebook Pixel
 ************************************************/
(function(){'use strict';
  var CURRENCY='RON';
  var LOCAL_BACKUP_KEY='savedCartForPurchase_v1';
  var LOCAL_BACKUP_TTL_MS=30*60*1000;
  var PURCHASE_DELAY_MS=2500;
  var IC_CLICK_DELAY_MS=500;

  // ============================
  // PRODUCT CATALOG MAPPING (RO)
  // ============================
  window.productCatalogMapping = {
  "408246751242": {
    "group": "invisia_x201",
    "variants": {
      "778968775512": "oo9OjTbNgZ8SJAWgghj610"
    }
  },
  "144672586112": {
    "group": "lightra_x030",
    "variants": {
      "808560176502": "Rv6KF1WLiPamjAv2BaZge3"
    }
  },
  "456023117542": {
    "group": "lightra_x015",
    "variants": {
      "935810110972": "olHJtrUhhLVDB5FN2Is6G0"
    }
  },
  "196701299832": {
    "group": "lightra_x030_s",
    "variants": {
      "325059620482": "MzeeWUC0gyE9JJJLbz34v3"
    }
  },
  "156269856802": {
    "group": "lightra_x050",
    "variants": {
      "770514350612": "wDQZybWWgNkn2Zq49zPi30"
    }
  },
  "173117135412": {
    "group": "curtina_x402",
    "variants": {
      "301964519272": "e9yQf8rDjzi3XjGnnx3Iw3",
      "956663279972": "DKTDmwA2icCZL2vSUjXum3",
      "458830194052": "vdjAWIcdhHNfZhVE150J92",
      "973723430772": "eePmEHIghXucCCjWcE2zy3"
    }
  },
  "333014532202": {
    "group": "curtina_x403",
    "variants": {
      "293267787752": "yUubMVw1hqQAZdBztKRgZ2",
      "196174289902": "hSqFGvnTjaggVAymnovmh0",
      "701472319152": "smfA9ADrg9P4AffHsiprN2",
      "265935541592": "Hxf-n56DhLa95Jq8oTmSb3",
      "131946916342": "i3hGepcZiU3L8JqEJ2rtV0",
      "848779219262": "jx2sQ0lhiTZsQVWNF9X2z0",
      "822614506962": "34WwfpBUjupvpuPa3EpLr3"
    }
  },
  "287608978832": {
    "group": "curtina_x405",
    "variants": {
      "592438478472": "zRy2mTY3io-ReCRagT1MI2",
      "505180922232": "9YYv8DXkjKpGTTDe3j99Y3",
      "117525235192": "M7K8jSGug5rmTO1txLm922",
      "803744608822": "Rid7eYeaihDEYyuGmwIm10",
      "876089740212": "hRYJaVIahB4Jg-O10ZpbV0",
      "759586955132": "QYtmUePthsfmVcpZ7LaHB2"
    }
  },
  "847012159042": {
    "group": "floatia_x301",
    "variants": {
      "747944340262": "jzysdA0nhEDukcRfamitz0"
    }
  },
  "723868210042": {
    "group": "floatia_x302",
    "variants": {
      "860427790322": "IxT7oD8zhIbrnn2LbGw2D0",
      "267826441912": "Y7mho3jShobDY2hUqkXX83",
      "673141786352": "fxcs1s4Sg4i9usohMYyp11"
    }
  },
  "473336826572": {
    "group": "invisia_x202",
    "variants": {
      "799765399652": "DJNjCqquhcS8YMhhFUUT-3"
    }
  },
  "159363313312": {
    "group": "invisia_x205",
    "variants": {
      "307017769502": "lFPD6yXiiis-LJnoPBaa91"
    }
  },
  "166924722462": {
    "group": "invisia_x204",
    "variants": {
      "823128693102": "zA59TVMAiMOOTZf15BUvl2"
    }
  },
  "542484472972": {
    "group": "inserta_y015_f",
    "variants": {
      "212309594222": "CWpGaKdlgRQIwS9TWZI6n0"
    }
  },
  "403840388992": {
    "group": "inserta_y030",
    "variants": {
      "419150027512": "MP9kMK6mg9LT--ZPdvSbb1"
    }
  },
  "677912169582": {
    "group": "classix_x140",
    "variants": {
      "146115888752": "V3cnnvOSiRXwOxWDjbAgp3"
    }
  },
  "361854489052": {
    "group": "contura_x601",
    "variants": {
      "216356537132": "uOmKNKiKhPZzh4UNscvrM3"
    }
  },
  "920141555912": {
    "group": "anglova_y401",
    "variants": {
      "555776503232": "5Iae0Kl7jHu3J80n7k6Nu3"
    }
  },
  "394448842072": {
    "group": "inserta_y008",
    "variants": {
      "698879683832": "5A33vrjxg2INi6FdYvYHV1",
      "569361295072": "Zm1YLzGFjDyJzl5BQ2AZK2"
    }
  },
  "491476579732": {
    "group": "inserta_y015",
    "variants": {
      "614951245542": "jWf3YVZMj28oz3Vn9Ruwa1"
    }
  },
  "135491542972": {
    "group": "diffusy_y114",
    "variants": {
      "304306005972": "SVjKGGnNhIO8Ovbe-z0yF3"
    }
  },
  "281981378952": {
    "group": "diffusy_y130",
    "variants": {
      "767414018712": "5ET97eXngrRKDRbIJ4YhN2",
      "485436923792": "yfcIPkXYi7hGeHi9sRjg51"
    }
  },
  "763859363792": {
    "group": "diffusy_y150",
    "variants": {
      "254446403042": "Z0jQpgcsgfNvDPq3zycpi1"
    }
  },
  "470344598332": {
    "group": "endcapp_y205",
    "variants": {
      "810085484922": "0tjwIdlUikOX0Ujz8iz0g0",
      "339882443902": "s3hlPBkThtLs9b-VgS5-72"
    }
  },
  "273075540082": {
    "group": "endcapp_y201",
    "variants": {
      "676735416342": "h5ANH4hyhaQ0ahlbaV9nf3"
    }
  },
  "153689982452": {
    "group": "endcapp_y206",
    "variants": {
      "154341777782": "tPFY8g6HhI3goBhXwFAdR2",
      "716456601892": "qbmrWdNBhQrZ9Ppq1rO-N2"
    }
  },
  "988478381852": {
    "group": "endcapp_y202",
    "variants": {
      "177330421632": "9wJD0JkkglPzVeK5rRpif0"
    }
  },
  "459945405532": {
    "group": "endcapp_y207",
    "variants": {
      "852370180662": "cLEZP2Ssga1osq6fjuzBl3"
    }
  },
  "250855544632": {
    "group": "endcapp_y203",
    "variants": {
      "126408199142": "gjxLSmpZiFX6ORefsKjSS1"
    }
  },
  "574247086712": {
    "group": "endcapp_y204",
    "variants": {
      "111263757932": "mY3nP58iiQbbhe6E8ifuq2"
    }
  },
  "731234795962": {
    "group": "curtina_x406",
    "variants": {
      "321461814172": "vdRmfjJniS9p1gOygMbDs0",
      "598458446862": "08Gs75cLiwndvRDfwZZkQ2"
    }
  },
  "437903368922": {
    "group": "curtina_x407",
    "variants": {
      "384805841032": "cJyPtbDhhRAmihZrojWDn0",
      "255274699252": "gtIKBLtJghv4WzA42yxPP1"
    }
  },
  "860229210372": {
    "group": "invisia_x206",
    "variants": {
      "336484823622": "EGXmtijjgeQdvXQSqdLGi3"
    }
  },
  "578289099072": {
    "group": "invisia_x207",
    "variants": {
      "479831501182": "YZTju3ikgOF1-Sj6ktK6e2"
    }
  },
  "150169575472": {
    "group": "invisia_x208",
    "variants": {
      "994668282432": "eyVbkQihgGQtYR5EF0P4w0"
    }
  },
  "288954167352": {
    "group": "invisia_x209",
    "variants": {
      "462428431762": "cTT1GGAZj76alVXu4vaAe1",
      "425076540332": "EeRJkcybhq5xX9vhB-xzv3"
    }
  },
  "864047075712": {
    "group": "floatia_x303",
    "variants": {
      "832357855822": "xO7PAABriJTHSKVNGiuYl3",
      "906636968422": "MyI2v2JMhnRtUrh6H58nz0"
    }
  },
  "542737993872": {
    "group": "stratos_x701",
    "variants": {
      "938257585092": "mCMAr4yQhDaPX-LNJ5RD73"
    }
  },
  "180714057592": {
    "group": "classix_x130",
    "variants": {
      "351656730772": "lxFpGXGnhGh-TPEwCLiEt2"
    }
  },
  "593233210852": {
    "group": "classix_x101",
    "variants": {
      "380588718002": "rtBsri0AgIfzRs45xlYEo3"
    }
  },
  "576662810612": {
    "group": "stratos_x704",
    "variants": {
      "374541289962": "TTCe8rd4gfNWGALqZZ6XQ1",
      "988216812582": "5rGDU6PghnaCaAB4hbK363"
    }
  },
  "513642533402": {
    "group": "stratos_x703",
    "variants": {
      "658333943602": "9DTMhoqug8m-s5umlvoUH2"
    }
  },
  "511268989722": {
    "group": "stratos_x702",
    "variants": {
      "169849761712": "A8KXwZGog4GTrG3uTcqe72"
    }
  },
  "494525948182": {
    "group": "bandura_x801",
    "variants": {
      "606839674372": "Ld9AkcuQi0qA19EQUN-hA0"
    }
  },
  "217942369232": {
    "group": "hookara_y701",
    "variants": {
      "560023745642": "46uEut1Sg0K3ORag6S9WZ0",
      "607699718622": "mCFJaYpDhGQpcRyrmU8W81"
    }
  },
  "178020715732": {
    "group": "hookend_y704",
    "variants": {
      "525005778822": "ysB7srkLhvaXhUm2B-WED1",
      "424894777382": "rTvzIoD8go7VbGrUSWHeb2"
    }
  },
  "749903659052": {
    "group": "decorra",
    "variants": {
      "458412720982": "ergHrlZUg2QIND1V8IhSJ2",
      "944063163902": "Uol4AUi6iIvTMzs54EO9j2",
      "955812821282": "lp4e5bsYjDqziPV39cnuC2",
      "321097006522": "bmi8XCqTjEWJdGyaSuIyc0",
      "783208794242": "1DXQpiEKjE3GouFX6fQLj1",
      "379781585392": "Mi1z6scziBgnL27xWxmwT2"
    }
  },
  "641806196652": {
    "group": "aerooom",
    "variants": {
      "706260013052": "67Bbx0xngULuV9UzemHTF3",
      "803109027452": "jvZowSDbjriTyuZ4gKOP73",
      "486882816912": "QUUROkmnjacZooCUHKa9k1"
    }
  },
  "136496325732": {
    "group": "diffusy_y134",
    "variants": {
      "759332458082": "OKOeFss5i43IMv6ZjYcRM3"
    }
  },
  "598027277642": {
    "group": "aerroll_z",
    "variants": {
      "524475509742": "KKdTYiB5ilH9EwahKpKah0",
      "766815740002": "ARWzP670jnmjJZpK5JsEU1",
      "409179818542": "xP5AwirJg8GaTPI5ZRvbx2"
    }
  },
  "101987312642": {
    "group": "tissure_z405",
    "variants": {
      "481044407772": "Zroo3n3djONt0OopEffYs1",
      "322544497102": "ASFuUxWDgOBWCHN5ODymF1"
    }
  },
  "788646348982": {
    "group": "unitexa_z701",
    "variants": {
      "142075302762": "SQKcK9vigikWY0Agh6ZSX0",
      "904775031772": "zSQvbSNEiHa6S1KQEwaCY2"
    }
  },
  "558739558982": {
    "group": "lumnova_z008",
    "variants": {
      "951728721442": "eSviEBM8guhlvQefni07r1"
    }
  },
  "738971679242": {
    "group": "tissure_z401",
    "variants": {
      "821983628842": "1BcJh8vVg8aapGEcAUDrg1",
      "982705395482": "hymJQJJTjY-YeQVF1giqT1"
    }
  },
  "187580245912": {
    "group": "lamplix_x930",
    "variants": {
      "268577551862": "63SkQfPpjSYcEKuuMh-YG2"
    }
  },
  "775734410552": {
    "group": "lamplix_x950",
    "variants": {
      "427347716442": "Xo7o90pXhmhKf1FmlwptL2"
    }
  },
  "136449452752": {
    "group": "voltiva_z501",
    "variants": {
      "333574672972": "0WyuTzYWjCQp6Fj0LuztH0"
    }
  },
  "343236625502": {
    "group": "curtina_x405_m",
    "variants": {
      "164516627472": "iSRbWSLtitojIsPO0sI9x2",
      "718659662222": "gA28ToLCggK3W8YPSsFkT1",
      "339864126142": "CkVvKhJbiGhhK2anvHdB33",
      "802797533272": "PIsjk6JZiDyyFLIyu2lyU0"
    }
  },
  "968581961292": {
    "group": "floatia_x304",
    "variants": {
      "346589621152": "OGuLhFuVjSlwHsBusU5Sf1"
    }
  },
  "727520234412": {
    "group": "curtina_x408",
    "variants": {
      "250535359432": "FWceQ5ETivN6fBl0i-tWJ2"
    }
  },
  "406408166412": {
    "group": "curtina_x409",
    "variants": {
      "566926447962": "LhsJi728gSt1-qEKriOWU2"
    }
  },
  "774722272712": {
    "group": "curtina_x410",
    "variants": {
      "612166377572": "JLVFDRdrgtcM9IORQDzXv0"
    }
  },
  "103807104462": {
    "group": "curtina_x411",
    "variants": {
      "832085323322": "KmK1hPPBihH4KDyWNRaPo0"
    }
  },
  "902059193332": {
    "group": "curtina_x404",
    "variants": {
      "364738696702": "ryMNNy0Vjq1ciFgP2gUaK3",
      "808768864562": "6UZy5OEYgiU2cDd92z2R00"
    }
  },
  "524679377792": {
    "group": "slidene_y702",
    "variants": {
      "344794172552": "AxdssG3zilcc0nq8IRQCg0"
    }
  }
};

  // ============================
  // REVERSE MAPPING (Tilda UID â†’ External ID)
  // Ð”Ð»Ñ Ð±Ñ‹ÑÑ‚Ñ€Ð¾Ð³Ð¾ Ð¿Ð¾Ð¸ÑÐºÐ° External ID Ð¿Ð¾ Tilda UID
  // ============================
  window.tildaUidToExternalId = {};
  for (var parentUid in window.productCatalogMapping) {
    var mapping = window.productCatalogMapping[parentUid];
    for (var variantUid in mapping.variants) {
      window.tildaUidToExternalId[variantUid] = mapping.variants[variantUid];
    }
  }

  // ============================
  // HELPERS
  // ============================
  function deepClone(obj){ try { return JSON.parse(JSON.stringify(obj)); } catch(_) { return null; } }
  function waitForFbq(ready){ if (typeof window.fbq === 'function') return ready(); setTimeout(function(){ waitForFbq(ready); }, 100); }

  function getProductData(productElement) {
    if (!productElement) return null;
    var parentUid = productElement.getAttribute('data-product-gen-uid');
    var variantUid = productElement.getAttribute('data-product-uid');
    if (!parentUid || !variantUid) return null;

    var productMapping = window.productCatalogMapping[parentUid];
    if (!productMapping) return null;

    var variantId = productMapping.variants[variantUid];
    var fallbackUsed = false;
    if (!variantId) { variantId = productMapping.group; fallbackUsed = true; }

    var titleElement = productElement.querySelector('.js-product-name, .t-name, .t-store__card__title');
    var priceElement = productElement.querySelector('.js-product-price, .t-store__card__price-value');

    return {
      variant_id: variantId,
      content_name: titleElement ? titleElement.textContent.trim() : 'Product',
      value: priceElement ? parseFloat(String(priceElement.textContent).replace(/[^\d.,]/g, '').replace(',', '.')) : 0,
      fallback_used: fallbackUsed
    };
  }

  function snapshotCartFromTilda() {
    var contentIds = [], totalValue = 0, numItems = 0, fallbackUsed = false;

    if (!window.tcart || !Array.isArray(window.tcart.products) || window.tcart.products.length === 0) {
      return { content_ids: [], value: 0, num_items: 0, fallback_used: false, raw: null, order_id: null };
    }

    window.tcart.products.forEach(function(product) {
      var mapped = false;

      if (window.productCatalogMapping) {
        for (var parentUid in window.productCatalogMapping) {
          var m = window.productCatalogMapping[parentUid];
          if (m.variants[product.uid]) {
            contentIds.push(m.variants[product.uid]);
            mapped = true;
            break;
          }
        }
      }

      if (!mapped) {
        var parent = window.productCatalogMapping && window.productCatalogMapping[product.uid];
        if (parent) {
          var firstVariantUid = Object.keys(parent.variants)[0];
          var variantId = parent.variants[firstVariantUid];
          contentIds.push(variantId);
          mapped = true;
        }
      }

      if (!mapped) { contentIds.push(product.uid); fallbackUsed = true; }

      totalValue += parseFloat(product.price || 0) * parseInt(product.quantity || 1, 10);
      numItems += parseInt(product.quantity || 1, 10);
    });

    return {
      content_ids: contentIds,
      value: Number.isFinite(totalValue) ? Number(totalValue) : 0,
      num_items: numItems,
      fallback_used: fallbackUsed,
      raw: deepClone(window.tcart),
      order_id: (window.tcart && window.tcart.orderid) ? String(window.tcart.orderid) : null
    };
  }

  function persistSavedCart(cart){ try { localStorage.setItem(LOCAL_BACKUP_KEY, JSON.stringify({ ts: Date.now(), cart: cart })); } catch(e){} }
  function restoreSavedCart(maxAgeMs){
    try {
      var raw = localStorage.getItem(LOCAL_BACKUP_KEY);
      if (!raw) return null;
      var obj = JSON.parse(raw);
      if (!obj || !obj.cart) return null;
      if (maxAgeMs && Date.now() - (obj.ts || 0) > maxAgeMs) return null;
      return obj.cart;
    } catch(e){ return null; }
  }

  // ============================
  // FBQ INTERCEPTOR (v16.2)
  // ============================
  var _originalFbq = null;
  var _fbqReady = false;

  function installFbqInterceptor() {
    if (_fbqReady || typeof window.fbq === 'undefined') return;
    _fbqReady = true;
    _originalFbq = window.fbq;

    window.fbq = function() {
      var eventType = arguments[0];
      var eventName = arguments[1];
      var eventData = arguments[2];
      var eventOptions = arguments[3];

      if (eventType === 'track' && eventName === 'AddToCart') {
        var hasEventID = eventOptions && eventOptions.eventID;
        var hasContentIds = eventData && Array.isArray(eventData.content_ids) && eventData.content_ids.length > 0;

        if (!hasEventID && hasContentIds) {
          var tildaUid = eventData.content_ids[0];
          var externalId = window.tildaUidToExternalId[tildaUid];

          if (externalId) {
            var correctedData = deepClone(eventData);
            correctedData.content_ids = [externalId];
            var correctedOptions = { eventID: 'atc_' + externalId + '_' + Date.now() };

            try {
              console.log('ðŸ”§ v16.2 Ð˜Ð¡ÐŸÐ ÐÐ’Ð›Ð•ÐÐ˜Ð• AddToCart:', {
                from: tildaUid + ' (Tilda UID)',
                to: externalId + ' (External ID)',
                eventID: correctedOptions.eventID
              });
            } catch(_){}

            return _originalFbq.call(this, eventType, eventName, correctedData, correctedOptions);
          } else {
            try { console.warn('âš ï¸ v16.2: Tilda UID Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½:', tildaUid); } catch(_){}
          }
        }
      }

      return _originalFbq.apply(this, arguments);
    };

    for (var prop in _originalFbq) {
      if (_originalFbq.hasOwnProperty(prop)) { window.fbq[prop] = _originalFbq[prop]; }
    }

    try { console.log('âœ… v16.2 FBQ Interceptor ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½'); } catch(_){}
  }

  var purchaseSent = false;
  function sendPurchaseEvent(cartData) {
    if (purchaseSent) return;
    if (!cartData || !Array.isArray(cartData.content_ids) || cartData.content_ids.length === 0) return;

    purchaseSent = true;
    var eventId = cartData.order_id ? ('purchase_' + cartData.order_id) : ('purchase_' + Date.now());

    fbq('track', 'Purchase', {
      content_ids: cartData.content_ids,
      content_type: 'product',
      value: Number(cartData.value || 0),
      currency: CURRENCY,
      num_items: Number(cartData.num_items || 0)
    }, { eventID: eventId });

    try { console.log('ðŸŽ‰ Purchase sent', { value: cartData.value, currency: CURRENCY, num_items: cartData.num_items, eventID: eventId, fallback_used: !!cartData.fallback_used }); } catch(_){}
  }

  function initMetaPixelEnhanced() {
    if (typeof fbq === 'undefined') { setTimeout(initMetaPixelEnhanced, 100); return; }

    // Ð£Ð¡Ð¢ÐÐÐÐ’Ð›Ð˜Ð’ÐÐ•Ðœ ÐŸÐ•Ð Ð•Ð¥Ð’ÐÐ¢Ð§Ð˜Ðš ÐŸÐ•Ð Ð’Ð«Ðœ Ð”Ð•Ð›ÐžÐœ!
    installFbqInterceptor();

    function initViewContent() {
      var productElement = document.querySelector('[data-product-gen-uid][data-product-uid]');
      if (productElement) {
        var productData = getProductData(productElement);
        if (productData) {
          fbq('track', 'ViewContent', {
            content_name: productData.content_name,
            content_ids: [productData.variant_id],
            content_type: 'product',
            value: Number(productData.value || 0),
            currency: CURRENCY
          });
        }

        var observer = new MutationObserver(function(mutations) {
          mutations.forEach(function(mutation) {
            if (mutation.type === 'attributes' && mutation.attributeName === 'data-product-uid') {
              var newProductData = getProductData(productElement);
              if (newProductData) {
                fbq('track', 'ViewContent', {
                  content_name: newProductData.content_name,
                  content_ids: [newProductData.variant_id],
                  content_type: 'product',
                  value: Number(newProductData.value || 0),
                  currency: CURRENCY
                });
              }
            }
          });
        });
        observer.observe(productElement, { attributes: true, attributeFilter: ['data-product-uid'] });
      }
    }
    if (document.readyState === 'loading') { document.addEventListener('DOMContentLoaded', initViewContent); } else { initViewContent(); }

    document.addEventListener('tstore-cart-add', function() {
      var productElement = document.querySelector('[data-product-gen-uid][data-product-uid]');
      var productData = getProductData(productElement);
      if (productData) {
        fbq('track', 'AddToCart', {
          content_name: productData.content_name,
          content_ids: [productData.variant_id],
          content_type: 'product',
          value: Number(productData.value || 0),
          currency: CURRENCY
        }, { eventID: 'atc_' + productData.variant_id + '_' + Date.now() });
      }
      var snap = snapshotCartFromTilda();
      if (snap.content_ids.length > 0) { window.savedCartForPurchase = snap; persistSavedCart(snap); }
    });

    document.addEventListener('click', function(e) {
      var button = e.target && e.target.closest('a[href*="cart"], button');
      if (!button) return;
      var buttonText = (button.textContent || '').trim().toLowerCase();
      if (buttonText.includes('adaug') || buttonText.includes('coÈ™') || buttonText.includes('cos') || buttonText.includes('cart') ||
          buttonText.includes('dodaj') || buttonText.includes('kosz') || buttonText.includes('warenkorb')) {
        setTimeout(function() {
          var productElement = document.querySelector('[data-product-gen-uid][data-product-uid]');
          var productData = getProductData(productElement);
          if (productData) {
            fbq('track', 'AddToCart', {
              content_name: productData.content_name,
              content_ids: [productData.variant_id],
              content_type: 'product',
              value: Number(productData.value || 0),
              currency: CURRENCY
            }, { eventID: 'atc_' + productData.variant_id + '_' + Date.now() });
          }
          var snap = snapshotCartFromTilda();
          if (snap.content_ids.length > 0) { window.savedCartForPurchase = snap; persistSavedCart(snap); }
        }, 300);
      }
    });

    var checkoutInitiated = false;
    var checkoutObserver = new MutationObserver(function(mutations) {
      mutations.forEach(function(mutation) {
        mutation.addedNodes && Array.prototype.forEach.call(mutation.addedNodes, function(node) {
          if (node.nodeType !== 1 || checkoutInitiated) return;
          var checkoutFormField = node.querySelector && node.querySelector('input[name="name"], input[name="email"], input[placeholder*="Name"], input[placeholder*="Email"], input[placeholder*="Nume"]');
          if (checkoutFormField) {
            checkoutInitiated = true;
            var cartData = snapshotCartFromTilda();
            if (cartData.content_ids.length > 0) {
              window.savedCartForPurchase = cartData; persistSavedCart(cartData);
              fbq('track', 'InitiateCheckout', {
                content_ids: cartData.content_ids,
                content_type: 'product',
                value: Number(cartData.value || 0),
                currency: CURRENCY,
                num_items: Number(cartData.num_items || 0)
              }, { eventID: 'ic_dom_' + Date.now() });
            }
          }
        });
      });
    });
    checkoutObserver.observe(document.body, { childList: true, subtree: true });

    document.addEventListener('click', function(e) {
      var goCheckout = e.target && e.target.closest(
        'a[href*="checkout"], a[href*="#order"], a[href*="tilda/cart"], ' +
        'button[name="t-order"], button[data-tilda-store="checkout"], ' +
        '.t-store__cartwin-prodamount-wrapper .t-btn, .t706__cartwin-prodamount-wrapper .t-btn'
      );
      if (!goCheckout) return;

      var snapNow = snapshotCartFromTilda();
      if (snapNow.content_ids.length > 0) { window.savedCartForPurchase = snapNow; persistSavedCart(snapNow); }

      setTimeout(function() {
        var data = window.savedCartForPurchase || restoreSavedCart(LOCAL_BACKUP_TTL_MS) || snapshotCartFromTilda();
        if (data && data.content_ids.length > 0) {
          fbq('track', 'InitiateCheckout', {
            content_ids: data.content_ids,
            content_type: 'product',
            value: Number(data.value || 0),
            currency: CURRENCY,
            num_items: Number(data.num_items || 0)
          }, { eventID: 'ic_click_' + Date.now() });
        }
      }, IC_CLICK_DELAY_MS);
    });

    document.addEventListener('submit', function(e) {
      var form = e.target;
      if (!form) return;

      var isCheckoutForm =
        form.matches('.t-store__checkout-form form, form[action*="/payment"], form[action*="tilda"], form[id*="form"], form[class*="form"]') ||
        !!form.querySelector('input[name="name"], input[name="email"], input[type="email"], input[name*="mail" i], input[name*="name" i]');

      if (!isCheckoutForm) return;

      var snap = snapshotCartFromTilda();
      if (snap.content_ids.length > 0) { window.savedCartForPurchase = snap; persistSavedCart(snap); }

      setTimeout(function() {
        if (purchaseSent) return;
        var data = window.savedCartForPurchase || restoreSavedCart(LOCAL_BACKUP_TTL_MS) || snapshotCartFromTilda();
        if (data && data.content_ids.length > 0) { sendPurchaseEvent(data); }
      }, PURCHASE_DELAY_MS);
    }, true);

    function trySendPurchase() {
      if (purchaseSent) return;
      var data = window.savedCartForPurchase || restoreSavedCart(LOCAL_BACKUP_TTL_MS) || snapshotCartFromTilda();
      if (data && data.content_ids.length > 0) { sendPurchaseEvent(data); }
    }
    document.addEventListener('tildaform:success', trySendPurchase, false);
    document.addEventListener('tildaform:aftersuccess', trySendPurchase, false);
    document.addEventListener('tstore-checkout-success', trySendPurchase, false);

    if (document.querySelector('.t-store__thankyoupage')) {
      setTimeout(trySendPurchase, 1200);
    }

    document.addEventListener('tcart_change', function() {
      var snap2 = snapshotCartFromTilda();
      if (snap2.content_ids.length > 0) { window.savedCartForPurchase = snap2; persistSavedCart(snap2); }
    });

    try { console.log('ðŸ”§ Meta Pixel v16.2 (RO) Ð³Ð¾Ñ‚Ð¾Ð². Ð’Ð°Ð»ÑŽÑ‚Ð°:', CURRENCY); } catch(_){}
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function(){ waitForFbq(initMetaPixelEnhanced); });
  } else {
    waitForFbq(initMetaPixelEnhanced);
  }
})();
</script>

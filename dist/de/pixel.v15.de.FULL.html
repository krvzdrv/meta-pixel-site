<script>
/************************************************
 * ðŸŸ¦ META PIXEL + FACEBOOK/INSTAGRAM SHOPS
 * v15 â€” popup checkout fix, fallback, local backup, orderID eventID
 * Ð¡Ð°Ð¹Ñ‚: alumineu.de | Ð’Ð°Ð»ÑŽÑ‚Ð°: EUR
 * Pixel ID Ð±ÐµÑ€Ñ‘Ñ‚ÑÑ Ð¸Ð· Tilda â†’ Site Settings â†’ Analytics â†’ Facebook Pixel
 ************************************************/
(function(){'use strict';
  var CURRENCY='EUR';
  var LOCAL_BACKUP_KEY='savedCartForPurchase_v1';
  var LOCAL_BACKUP_TTL_MS=30*60*1000;
  var PURCHASE_DELAY_MS=2500;
  var IC_CLICK_DELAY_MS=500;

  // ============================
  // PRODUCT CATALOG MAPPING (DE)
  // 51 parents, 80 variants
  // ============================
  window.productCatalogMapping = {
    '442733295411': { group: 'invisia_x201', variants: { '815801714141': 'oo9OjTbNgZ8SJAWgghj610' } },
    '401127966721': { group: 'lightra_x030', variants: { '510496803981': 'Rv6KF1WLiPamjAv2BaZge3' } },
    '477064336861': { group: 'lightra_x015', variants: { '744771070761': 'olHJtrUhhLVDB5FN2Is6G0' } },
    '674701586561': { group: 'lightra_x030_s', variants: { '573449500411': 'MzeeWUC0gyE9JJJLbz34v3' } },
    '860758794541': { group: 'lightra_x050', variants: { '785067003561': 'wDQZybWWgNkn2Zq49zPi30' } },
    '702259624591': { group: 'curtina_x402', variants: { 
      '695056084041': 'e9yQf8rDjzi3XjGnnx3Iw3',
      '330396319901': 'DKTDmwA2icCZL2vSUjXum3',
      '361913046022': 'vdjAWIcdhHNfZhVE150J92',
      '215505426582': 'eePmEHIghXucCCjWcE2zy3'
    }},
    '511068471861': { group: 'floatia_x301', variants: { '737801824421': 'jzysdA0nhEDukcRfamitz0' } },
    '296614829931': { group: 'invisia_x202', variants: { '763141907871': 'DJNjCqquhcS8YMhhFUUT-3' } },
    '834487288081': { group: 'invisia_x205', variants: { '463017471261': 'lFPD6yXiiis-LJnoPBaa91' } },
    '688784940211': { group: 'invisia_x204', variants: { '439163409561': 'zA59TVMAiMOOTZf15BUvl2' } },
    '516248023571': { group: 'inserta_y015_f', variants: { '389788504061': 'CWpGaKdlgRQIwS9TWZI6n0' } },
    '820320102421': { group: 'inserta_y030', variants: { '740165393261': 'MP9kMK6mg9LT--ZPdvSbb1' } },
    '972999912221': { group: 'classix_x140', variants: { '280241505021': 'V3cnnvOSiRXwOxWDjbAgp3' } },
    '601597243121': { group: 'contura_x601', variants: { '298004226671': 'uOmKNKiKhPZzh4UNscvrM3' } },
    '903601380751': { group: 'anglova_y401', variants: { '834435705461': '5Iae0Kl7jHu3J80n7k6Nu3' } },
    '989701060781': { group: 'inserta_y008', variants: { 
      '631676915201': '5A33vrjxg2INi6FdYvYHV1',
      '664407343641': 'Zm1YLzGFjDyJzl5BQ2AZK2'
    }},
    '128574877981': { group: 'inserta_y015', variants: { '210738963631': 'jWf3YVZMj28oz3Vn9Ruwa1' } },
    '306408440381': { group: 'diffusy_y114', variants: { '267066387041': 'SVjKGGnNhIO8Ovbe-z0yF3' } },
    '736492946461': { group: 'diffusy_y130', variants: { 
      '323571157641': '5ET97eXngrRKDRbIJ4YhN2',
      '471254601322': 'yfcIPkXYi7hGeHi9sRjg51'
    }},
    '520194301621': { group: 'diffusy_y150', variants: { '746109330421': 'Z0jQpgcsgfNvDPq3zycpi1' } },
    '454560769811': { group: 'endcapp_y205', variants: { 
      '161270122041': '0tjwIdlUikOX0Ujz8iz0g0',
      '607025546201': 's3hlPBkThtLs9b-VgS5-72'
    }},
    '611157772331': { group: 'endcapp_y201', variants: { '231605950141': 'h5ANH4hyhaQ0ahlbaV9nf3' } },
    '884939976731': { group: 'endcapp_y206', variants: { 
      '104238911941': 'tPFY8g6HhI3goBhXwFAdR2',
      '834123095482': 'qbmrWdNBhQrZ9Ppq1rO-N2'
    }},
    '458051350651': { group: 'endcapp_y202', variants: { '447817890291': '9wJD0JkkglPzVeK5rRpif0' } },
    '135189710841': { group: 'endcapp_y207', variants: { '466805052782': 'cLEZP2Ssga1osq6fjuzBl3' } },
    '840003235331': { group: 'endcapp_y204', variants: { '716161195161': 'mY3nP58iiQbbhe6E8ifuq2' } },
    '258804088851': { group: 'endcapp_y203', variants: { '638881995721': 'gjxLSmpZiFX6ORefsKjSS1' } },
    '244022033352': { group: 'classix_x101', variants: { '536934646932': 'rtBsri0AgIfzRs45xlYEo3' } },
    '655075750852': { group: 'classix_x130', variants: { '870397026532': 'lxFpGXGnhGh-TPEwCLiEt2' } },
    '532236042432': { group: 'invisia_x206', variants: { '416048977772': 'EGXmtijjgeQdvXQSqdLGi3' } },
    '448575031522': { group: 'invisia_x207', variants: { '108830859612': 'YZTju3ikgOF1-Sj6ktK6e2' } },
    '594015128372': { group: 'invisia_x208', variants: { '439166830922': 'eyVbkQihgGQtYR5EF0P4w0' } },
    '154636665012': { group: 'invisia_x209', variants: { 
      '664079902622': 'cTT1GGAZj76alVXu4vaAe1',
      '215949324572': 'EeRJkcybhq5xX9vhB-xzv3'
    }},
    '997882810142': { group: 'floatia_x303', variants: { 
      '769222256172': 'VL9D-5xNhHiRwdOhXxgjl3',
      '267068344872': 'xO7PAABriJTHSKVNGiuYl3',
      '993946525262': 'MyI2v2JMhnRtUrh6H58nz0'
    }},
    '210183251962': { group: 'floatia_x302', variants: { 
      '817061220332': 'IxT7oD8zhIbrnn2LbGw2D0',
      '450749495132': 'Y7mho3jShobDY2hUqkXX83',
      '549075235292': 'fxcs1s4Sg4i9usohMYyp11'
    }},
    '248920853142': { group: 'curtina_x403', variants: { 
      '956571154802': 'yUubMVw1hqQAZdBztKRgZ2',
      '655672336162': 'hSqFGvnTjaggVAymnovmh0',
      '104057293562': 'smfA9ADrg9P4AffHsiprN2',
      '121407847472': 'Hxf-n56DhLa95Jq8oTmSb3',
      '308702622892': '34WwfpBUjupvpuPa3EpLr3',
      '384095982592': 'i3hGepcZiU3L8JqEJ2rtV0',
      '347030116842': 'jx2sQ0lhiTZsQVWNF9X2z0'
    }},
    '887911625442': { group: 'curtina_x405', variants: { 
      '548490948072': 'zRy2mTY3io-ReCRagT1MI2',
      '428208056282': '9YYv8DXkjKpGTTDe3j99Y3',
      '256291393412': 'M7K8jSGug5rmTO1txLm922',
      '873406416852': 'Rid7eYeaihDEYyuGmwIm10',
      '750234824842': 'hRYJaVIahB4Jg-O10ZpbV0',
      '576926526152': 'QYtmUePthsfmVcpZ7LaHB2'
    }},
    '584241463252': { group: 'curtina_x406', variants: { 
      '483379290462': 'vdRmfjJniS9p1gOygMbDs0',
      '747872544362': '08Gs75cLiwndvRDfwZZkQ2'
    }},
    '327751847912': { group: 'curtina_x407', variants: { 
      '511209364352': 'cJyPtbDhhRAmihZrojWDn0',
      '133200592282': 'gtIKBLtJghv4WzA42yxPP1'
    }},
    '583223803412': { group: 'stratos_x701', variants: { '661797286792': 'mCMAr4yQhDaPX-LNJ5RD73' } },
    '738757843562': { group: 'stratos_x702', variants: { '545285112872': 'A8KXwZGog4GTrG3uTcqe72' } },
    '288507761852': { group: 'stratos_x703', variants: { '473803836062': '9DTMhoqug8m-s5umlvoUH2' } },
    '931938974532': { group: 'stratos_x704', variants: { 
      '183339350492': 'TTCe8rd4gfNWGALqZZ6XQ1',
      '739115973432': '5rGDU6PghnaCaAB4hbK363'
    }},
    '214163110132': { group: 'bandura_x801', variants: { '803224210062': 'Ld9AkcuQi0qA19EQUN-hA0' } },
    '421906885552': { group: 'diffusy_y134', variants: { '692471598272': 'OKOeFss5i43IMv6ZjYcRM3' } },
    '484817318102': { group: 'lamplix_x950', variants: { '193834781942': 'Xo7o90pXhmhKf1FmlwptL2' } },
    '877187536992': { group: 'lamplix_x930', variants: { '261995923602': '63SkQfPpjSYcEKuuMh-YG2' } },
    '839408572062': { group: 'floatia_x304', variants: { '571996272972': 'OGuLhFuVjSlwHsBusU5Sf1' } },
    '930556804002': { group: 'curtina_x404', variants: { 
      '684471350662': 'ryMNNy0Vjq1ciFgP2gUaK3',
      '636218153652': '6UZy5OEYgiU2cDd92z2R00'
    }},
    '357788908752': { group: 'curtina_x405_m', variants: { 
      '376404890662': 'iSRbWSLtitojIsPO0sI9x2',
      '813071254712': 'gA28ToLCggK3W8YPSsFkT1',
      '239473994132': 'CkVvKhJbiGhhK2anvHdB33',
      '143618961252': 'PIsjk6JZiDyyFLIyu2lyU0'
    }},
    '255383169822': { group: 'curtina_x408', variants: { '214899874702': 'FWceQ5ETivN6fBl0i-tWJ2' } },
    '241166415182': { group: 'curtina_x409', variants: { '403098122232': 'LhsJi728gSt1-qEKriOWU2' } },
    '684148890872': { group: 'curtina_x410', variants: { '661064747832': 'JLVFDRdrgtcM9IORQDzXv0' } },
    '259187621202': { group: 'curtina_x411', variants: { '570978296822': 'KmK1hPPBihH4KDyWNRaPo0' } }
  };

  // ============================
  // HELPERS
  // ============================
  function deepClone(obj){ try { return JSON.parse(JSON.stringify(obj)); } catch(_) { return null; } }
  function waitForFbq(ready){ if (typeof window.fbq === 'function') return ready(); setTimeout(function(){ waitForFbq(ready); }, 100); }

  function getProductData(productElement) {
    if (!productElement) return null;
    var parentUid = productElement.getAttribute('data-product-gen-uid');
    var variantUid = productElement.getAttribute('data-product-uid');
    if (!parentUid || !variantUid) return null;

    var productMapping = window.productCatalogMapping[parentUid];
    if (!productMapping) return null;

    var variantId = productMapping.variants[variantUid];
    var fallbackUsed = false;
    if (!variantId) { variantId = productMapping.group; fallbackUsed = true; }

    var titleElement = productElement.querySelector('.js-product-name, .t-name, .t-store__card__title');
    var priceElement = productElement.querySelector('.js-product-price, .t-store__card__price-value');

    return {
      variant_id: variantId,
      content_name: titleElement ? titleElement.textContent.trim() : 'Product',
      value: priceElement ? parseFloat(String(priceElement.textContent).replace(/[^\d.,]/g, '').replace(',', '.')) : 0,
      fallback_used: fallbackUsed
    };
  }

  function snapshotCartFromTilda() {
    var contentIds = [], totalValue = 0, numItems = 0, fallbackUsed = false;

    if (!window.tcart || !Array.isArray(window.tcart.products) || window.tcart.products.length === 0) {
      return { content_ids: [], value: 0, num_items: 0, fallback_used: false, raw: null, order_id: null };
    }

    window.tcart.products.forEach(function(product) {
      var mapped = false;

      if (window.productCatalogMapping) {
        for (var parentUid in window.productCatalogMapping) {
          var m = window.productCatalogMapping[parentUid];
          if (m.variants[product.uid]) {
            contentIds.push(m.variants[product.uid]);
            mapped = true;
            break;
          }
        }
      }

      if (!mapped) {
        var parent = window.productCatalogMapping && window.productCatalogMapping[product.uid];
        if (parent) {
          var firstVariantUid = Object.keys(parent.variants)[0];
          var variantId = parent.variants[firstVariantUid];
          contentIds.push(variantId);
          mapped = true;
        }
      }

      if (!mapped) { contentIds.push(product.uid); fallbackUsed = true; }

      totalValue += parseFloat(product.price || 0) * parseInt(product.quantity || 1, 10);
      numItems += parseInt(product.quantity || 1, 10);
    });

    return {
      content_ids: contentIds,
      value: Number.isFinite(totalValue) ? Number(totalValue) : 0,
      num_items: numItems,
      fallback_used: fallbackUsed,
      raw: deepClone(window.tcart),
      order_id: (window.tcart && window.tcart.orderid) ? String(window.tcart.orderid) : null
    };
  }

  function persistSavedCart(cart){ try { localStorage.setItem(LOCAL_BACKUP_KEY, JSON.stringify({ ts: Date.now(), cart: cart })); } catch(e){} }
  function restoreSavedCart(maxAgeMs){
    try {
      var raw = localStorage.getItem(LOCAL_BACKUP_KEY);
      if (!raw) return null;
      var obj = JSON.parse(raw);
      if (!obj || !obj.cart) return null;
      if (maxAgeMs && Date.now() - (obj.ts || 0) > maxAgeMs) return null;
      return obj.cart;
    } catch(e){ return null; }
  }

  var purchaseSent = false;
  function sendPurchaseEvent(cartData) {
    if (purchaseSent) return;
    if (!cartData || !Array.isArray(cartData.content_ids) || cartData.content_ids.length === 0) return;

    purchaseSent = true;
    var eventId = cartData.order_id ? ('purchase_' + cartData.order_id) : ('purchase_' + Date.now());

    fbq('track', 'Purchase', {
      content_ids: cartData.content_ids,
      content_type: 'product',
      value: Number(cartData.value || 0),
      currency: CURRENCY,
      num_items: Number(cartData.num_items || 0)
    }, { eventID: eventId });

    try { console.log('ðŸŽ‰ Purchase sent', { value: cartData.value, currency: CURRENCY, num_items: cartData.num_items, eventID: eventId, fallback_used: !!cartData.fallback_used }); } catch(_){}
  }

  function initMetaPixelEnhanced() {
    if (typeof fbq === 'undefined') { setTimeout(initMetaPixelEnhanced, 100); return; }

    function initViewContent() {
      var productElement = document.querySelector('[data-product-gen-uid][data-product-uid]');
      if (productElement) {
        var productData = getProductData(productElement);
        if (productData) {
          fbq('track', 'ViewContent', {
            content_name: productData.content_name,
            content_ids: [productData.variant_id],
            content_type: 'product',
            value: Number(productData.value || 0),
            currency: CURRENCY
          });
        }

        var observer = new MutationObserver(function(mutations) {
          mutations.forEach(function(mutation) {
            if (mutation.type === 'attributes' && mutation.attributeName === 'data-product-uid') {
              var newProductData = getProductData(productElement);
              if (newProductData) {
                fbq('track', 'ViewContent', {
                  content_name: newProductData.content_name,
                  content_ids: [newProductData.variant_id],
                  content_type: 'product',
                  value: Number(newProductData.value || 0),
                  currency: CURRENCY
                });
              }
            }
          });
        });
        observer.observe(productElement, { attributes: true, attributeFilter: ['data-product-uid'] });
      }
    }
    if (document.readyState === 'loading') { document.addEventListener('DOMContentLoaded', initViewContent); } else { initViewContent(); }

    document.addEventListener('tstore-cart-add', function() {
      var productElement = document.querySelector('[data-product-gen-uid][data-product-uid]');
      var productData = getProductData(productElement);
      if (productData) {
        fbq('track', 'AddToCart', {
          content_name: productData.content_name,
          content_ids: [productData.variant_id],
          content_type: 'product',
          value: Number(productData.value || 0),
          currency: CURRENCY
        });
      }
      var snap = snapshotCartFromTilda();
      if (snap.content_ids.length > 0) { window.savedCartForPurchase = snap; persistSavedCart(snap); }
    });

    document.addEventListener('click', function(e) {
      var button = e.target && e.target.closest('a[href*="cart"], button');
      if (!button) return;
      var buttonText = (button.textContent || '').trim().toLowerCase();
      if (buttonText.includes('warenkorb') || buttonText.includes('cart') || buttonText.includes('in den') ||
          buttonText.includes('dodaj') || buttonText.includes('kosz') || buttonText.includes('adaug') || buttonText.includes('coÈ™')) {
        setTimeout(function() {
          var productElement = document.querySelector('[data-product-gen-uid][data-product-uid]');
          var productData = getProductData(productElement);
          if (productData) {
            fbq('track', 'AddToCart', {
              content_name: productData.content_name,
              content_ids: [productData.variant_id],
              content_type: 'product',
              value: Number(productData.value || 0),
              currency: CURRENCY
            });
          }
          var snap = snapshotCartFromTilda();
          if (snap.content_ids.length > 0) { window.savedCartForPurchase = snap; persistSavedCart(snap); }
        }, 300);
      }
    });

    var checkoutInitiated = false;
    var checkoutObserver = new MutationObserver(function(mutations) {
      mutations.forEach(function(mutation) {
        mutation.addedNodes && Array.prototype.forEach.call(mutation.addedNodes, function(node) {
          if (node.nodeType !== 1 || checkoutInitiated) return;
          var checkoutFormField = node.querySelector && node.querySelector('input[name="name"], input[name="email"], input[placeholder*="Name"], input[placeholder*="Email"], input[placeholder*="Nume"]');
          if (checkoutFormField) {
            checkoutInitiated = true;
            var cartData = snapshotCartFromTilda();
            if (cartData.content_ids.length > 0) {
              window.savedCartForPurchase = cartData; persistSavedCart(cartData);
              fbq('track', 'InitiateCheckout', {
                content_ids: cartData.content_ids,
                content_type: 'product',
                value: Number(cartData.value || 0),
                currency: CURRENCY,
                num_items: Number(cartData.num_items || 0)
              }, { eventID: 'ic_dom_' + Date.now() });
            }
          }
        });
      });
    });
    checkoutObserver.observe(document.body, { childList: true, subtree: true });

    document.addEventListener('click', function(e) {
      var goCheckout = e.target && e.target.closest(
        'a[href*="checkout"], a[href*="#order"], a[href*="tilda/cart"], ' +
        'button[name="t-order"], button[data-tilda-store="checkout"], ' +
        '.t-store__cartwin-prodamount-wrapper .t-btn, .t706__cartwin-prodamount-wrapper .t-btn'
      );
      if (!goCheckout) return;

      var snapNow = snapshotCartFromTilda();
      if (snapNow.content_ids.length > 0) { window.savedCartForPurchase = snapNow; persistSavedCart(snapNow); }

      setTimeout(function() {
        var data = window.savedCartForPurchase || restoreSavedCart(LOCAL_BACKUP_TTL_MS) || snapshotCartFromTilda();
        if (data && data.content_ids.length > 0) {
          fbq('track', 'InitiateCheckout', {
            content_ids: data.content_ids,
            content_type: 'product',
            value: Number(data.value || 0),
            currency: CURRENCY,
            num_items: Number(data.num_items || 0)
          }, { eventID: 'ic_click_' + Date.now() });
        }
      }, IC_CLICK_DELAY_MS);
    });

    document.addEventListener('submit', function(e) {
      var form = e.target;
      if (!form) return;

      var isCheckoutForm =
        form.matches('.t-store__checkout-form form, form[action*="/payment"], form[action*="tilda"], form[id*="form"], form[class*="form"]') ||
        !!form.querySelector('input[name="name"], input[name="email"], input[type="email"], input[name*="mail" i], input[name*="name" i]');

      if (!isCheckoutForm) return;

      var snap = snapshotCartFromTilda();
      if (snap.content_ids.length > 0) { window.savedCartForPurchase = snap; persistSavedCart(snap); }

      setTimeout(function() {
        if (purchaseSent) return;
        var data = window.savedCartForPurchase || restoreSavedCart(LOCAL_BACKUP_TTL_MS) || snapshotCartFromTilda();
        if (data && data.content_ids.length > 0) { sendPurchaseEvent(data); }
      }, PURCHASE_DELAY_MS);
    }, true);

    function trySendPurchase() {
      if (purchaseSent) return;
      var data = window.savedCartForPurchase || restoreSavedCart(LOCAL_BACKUP_TTL_MS) || snapshotCartFromTilda();
      if (data && data.content_ids.length > 0) { sendPurchaseEvent(data); }
    }
    document.addEventListener('tildaform:success', trySendPurchase, false);
    document.addEventListener('tildaform:aftersuccess', trySendPurchase, false);
    document.addEventListener('tstore-checkout-success', trySendPurchase, false);

    if (document.querySelector('.t-store__thankyoupage')) {
      setTimeout(trySendPurchase, 1200);
    }

    document.addEventListener('tcart_change', function() {
      var snap2 = snapshotCartFromTilda();
      if (snap2.content_ids.length > 0) { window.savedCartForPurchase = snap2; persistSavedCart(snap2); }
    });

    try { console.log('ðŸ”§ Meta Pixel v15 (DE) Ð³Ð¾Ñ‚Ð¾Ð². Ð’Ð°Ð»ÑŽÑ‚Ð°:', CURRENCY); } catch(_){}
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function(){ waitForFbq(initMetaPixelEnhanced); });
  } else {
    waitForFbq(initMetaPixelEnhanced);
  }
})();
</script>


<script>
/************************************************
 * ðŸŸ¦ META PIXEL + FACEBOOK/INSTAGRAM SHOPS
 * v16.2 â€” FBQ INTERCEPTOR: Fix Tilda's wrong content_ids
 * 
 * ÐšÐ Ð˜Ð¢Ð˜Ð§Ð•Ð¡ÐšÐžÐ• Ð˜Ð¡ÐŸÐ ÐÐ’Ð›Ð•ÐÐ˜Ð•:
 * Tilda Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÑ‚ AddToCart Ñ Tilda UID Ð²Ð¼ÐµÑÑ‚Ð¾ External ID
 * Tilda ÐÐ• Ð³ÐµÐ½ÐµÑ€Ð¸Ñ€ÑƒÐµÑ‚ ÑÐ¾Ð±Ñ‹Ñ‚Ð¸Ðµ tstore-cart-add
 * Ð ÐµÑˆÐµÐ½Ð¸Ðµ: ÐŸÐµÑ€ÐµÑ…Ð²Ð°Ñ‚Ñ‹Ð²Ð°ÐµÐ¼ fbq Ð¸ Ð¸ÑÐ¿Ñ€Ð°Ð²Ð»ÑÐµÐ¼ content_ids Ð½Ð° Ð»ÐµÑ‚Ñƒ
 * 
 * Ð¡Ð°Ð¹Ñ‚: alumineu.de | Ð’Ð°Ð»ÑŽÑ‚Ð°: EUR
 * Pixel ID Ð±ÐµÑ€Ñ‘Ñ‚ÑÑ Ð¸Ð· Tilda â†’ Site Settings â†’ Analytics â†’ Facebook Pixel
 ************************************************/
(function(){'use strict';
  var CURRENCY='EUR';
  var LOCAL_BACKUP_KEY='savedCartForPurchase_v1';
  var LOCAL_BACKUP_TTL_MS=30*60*1000;
  var PURCHASE_DELAY_MS=2500;
  var IC_CLICK_DELAY_MS=500;

  // ============================
  // PRODUCT CATALOG MAPPING (DE)
  // 51 parents, 80 variants
  // ============================
    window.productCatalogMapping = {
    "442733295411": {
        "group": "invisia_x201",
        "variants": {
            "815801714141": "oo9OjTbNgZ8SJAWgghj610"
        }
    },
    "401127966721": {
        "group": "lightra_x030",
        "variants": {
            "510496803981": "Rv6KF1WLiPamjAv2BaZge3"
        }
    },
    "477064336861": {
        "group": "lightra_x015",
        "variants": {
            "744771070761": "olHJtrUhhLVDB5FN2Is6G0"
        }
    },
    "674701586561": {
        "group": "lightra_x030_s",
        "variants": {
            "573449500411": "MzeeWUC0gyE9JJJLbz34v3"
        }
    },
    "860758794541": {
        "group": "lightra_x050",
        "variants": {
            "785067003561": "wDQZybWWgNkn2Zq49zPi30"
        }
    },
    "511068471861": {
        "group": "floatia_x301",
        "variants": {
            "737801824421": "jzysdA0nhEDukcRfamitz0"
        }
    },
    "296614829931": {
        "group": "invisia_x202",
        "variants": {
            "763141907871": "DJNjCqquhcS8YMhhFUUT-3"
        }
    },
    "834487288081": {
        "group": "invisia_x205",
        "variants": {
            "463017471261": "lFPD6yXiiis-LJnoPBaa91"
        }
    },
    "688784940211": {
        "group": "invisia_x204",
        "variants": {
            "439163409561": "zA59TVMAiMOOTZf15BUvl2"
        }
    },
    "516248023571": {
        "group": "inserta_y015_f",
        "variants": {
            "389788504061": "CWpGaKdlgRQIwS9TWZI6n0"
        }
    },
    "820320102421": {
        "group": "inserta_y030",
        "variants": {
            "740165393261": "MP9kMK6mg9LT--ZPdvSbb1"
        }
    },
    "972999912221": {
        "group": "classix_x140",
        "variants": {
            "280241505021": "V3cnnvOSiRXwOxWDjbAgp3"
        }
    },
    "601597243121": {
        "group": "contura_x601",
        "variants": {
            "298004226671": "uOmKNKiKhPZzh4UNscvrM3"
        }
    },
    "903601380751": {
        "group": "anglova_y401",
        "variants": {
            "834435705461": "5Iae0Kl7jHu3J80n7k6Nu3"
        }
    },
    "128574877981": {
        "group": "inserta_y015",
        "variants": {
            "210738963631": "jWf3YVZMj28oz3Vn9Ruwa1"
        }
    },
    "306408440381": {
        "group": "diffusy_y114",
        "variants": {
            "267066387041": "SVjKGGnNhIO8Ovbe-z0yF3"
        }
    },
    "520194301621": {
        "group": "diffusy_y150",
        "variants": {
            "746109330421": "Z0jQpgcsgfNvDPq3zycpi1"
        }
    },
    "611157772331": {
        "group": "endcapp_y201",
        "variants": {
            "231605950141": "h5ANH4hyhaQ0ahlbaV9nf3"
        }
    },
    "458051350651": {
        "group": "endcapp_y202",
        "variants": {
            "447817890291": "9wJD0JkkglPzVeK5rRpif0"
        }
    },
    "135189710841": {
        "group": "endcapp_y207",
        "variants": {
            "466805052782": "cLEZP2Ssga1osq6fjuzBl3"
        }
    },
    "840003235331": {
        "group": "endcapp_y204",
        "variants": {
            "716161195161": "mY3nP58iiQbbhe6E8ifuq2"
        }
    },
    "258804088851": {
        "group": "endcapp_y203",
        "variants": {
            "638881995721": "gjxLSmpZiFX6ORefsKjSS1"
        }
    },
    "244022033352": {
        "group": "classix_x101",
        "variants": {
            "536934646932": "rtBsri0AgIfzRs45xlYEo3"
        }
    },
    "655075750852": {
        "group": "classix_x130",
        "variants": {
            "870397026532": "lxFpGXGnhGh-TPEwCLiEt2"
        }
    },
    "532236042432": {
        "group": "invisia_x206",
        "variants": {
            "416048977772": "EGXmtijjgeQdvXQSqdLGi3"
        }
    },
    "448575031522": {
        "group": "invisia_x207",
        "variants": {
            "108830859612": "YZTju3ikgOF1-Sj6ktK6e2"
        }
    },
    "594015128372": {
        "group": "invisia_x208",
        "variants": {
            "439166830922": "eyVbkQihgGQtYR5EF0P4w0"
        }
    },
    "583223803412": {
        "group": "stratos_x701",
        "variants": {
            "661797286792": "mCMAr4yQhDaPX-LNJ5RD73"
        }
    },
    "738757843562": {
        "group": "stratos_x702",
        "variants": {
            "545285112872": "A8KXwZGog4GTrG3uTcqe72"
        }
    },
    "288507761852": {
        "group": "stratos_x703",
        "variants": {
            "473803836062": "9DTMhoqug8m-s5umlvoUH2"
        }
    },
    "214163110132": {
        "group": "bandura_x801",
        "variants": {
            "803224210062": "Ld9AkcuQi0qA19EQUN-hA0"
        }
    },
    "421906885552": {
        "group": "diffusy_y134",
        "variants": {
            "692471598272": "OKOeFss5i43IMv6ZjYcRM3"
        }
    },
    "484817318102": {
        "group": "lamplix_x950",
        "variants": {
            "193834781942": "Xo7o90pXhmhKf1FmlwptL2"
        }
    },
    "877187536992": {
        "group": "lamplix_x930",
        "variants": {
            "261995923602": "63SkQfPpjSYcEKuuMh-YG2"
        }
    },
    "839408572062": {
        "group": "floatia_x304",
        "variants": {
            "571996272972": "OGuLhFuVjSlwHsBusU5Sf1"
        }
    },
    "255383169822": {
        "group": "curtina_x408",
        "variants": {
            "214899874702": "FWceQ5ETivN6fBl0i-tWJ2"
        }
    },
    "241166415182": {
        "group": "curtina_x409",
        "variants": {
            "403098122232": "LhsJi728gSt1-qEKriOWU2"
        }
    },
    "684148890872": {
        "group": "curtina_x410",
        "variants": {
            "661064747832": "JLVFDRdrgtcM9IORQDzXv0"
        }
    },
    "259187621202": {
        "group": "curtina_x411",
        "variants": {
            "570978296822": "KmK1hPPBihH4KDyWNRaPo0"
        }
    }
};

  // ============================
  // REVERSE MAPPING (Tilda UID â†’ External ID)
  // Ð”Ð»Ñ Ð±Ñ‹ÑÑ‚Ñ€Ð¾Ð³Ð¾ Ð¿Ð¾Ð¸ÑÐºÐ° External ID Ð¿Ð¾ Tilda UID
  // ============================
  window.tildaUidToExternalId = {};
  for (var parentUid in window.productCatalogMapping) {
    var mapping = window.productCatalogMapping[parentUid];
    for (var variantUid in mapping.variants) {
      window.tildaUidToExternalId[variantUid] = mapping.variants[variantUid];
    }
  }

  // ============================
  // HELPERS
  // ============================
  function deepClone(obj){ try { return JSON.parse(JSON.stringify(obj)); } catch(_) { return null; } }
  function waitForFbq(ready){ if (typeof window.fbq === 'function') return ready(); setTimeout(function(){ waitForFbq(ready); }, 100); }

  function getProductData(productElement) {
    if (!productElement) return null;
    var parentUid = productElement.getAttribute('data-product-gen-uid');
    var variantUid = productElement.getAttribute('data-product-uid');
    if (!parentUid || !variantUid) return null;

    var productMapping = window.productCatalogMapping[parentUid];
    if (!productMapping) return null;

    var variantId = productMapping.variants[variantUid];
    var fallbackUsed = false;
    if (!variantId) { variantId = productMapping.group; fallbackUsed = true; }

    var titleElement = productElement.querySelector('.js-product-name, .t-name, .t-store__card__title');
    var priceElement = productElement.querySelector('.js-product-price, .t-store__card__price-value');

    return {
      variant_id: variantId,
      content_name: titleElement ? titleElement.textContent.trim() : 'Product',
      value: priceElement ? parseFloat(String(priceElement.textContent).replace(/[^\d.,]/g, '').replace(',', '.')) : 0,
      fallback_used: fallbackUsed
    };
  }

  function snapshotCartFromTilda() {
    var contentIds = [], totalValue = 0, numItems = 0, fallbackUsed = false;

    if (!window.tcart || !Array.isArray(window.tcart.products) || window.tcart.products.length === 0) {
      return { content_ids: [], value: 0, num_items: 0, fallback_used: false, raw: null, order_id: null };
    }

    window.tcart.products.forEach(function(product) {
      var mapped = false;

      if (window.productCatalogMapping) {
        for (var parentUid in window.productCatalogMapping) {
          var m = window.productCatalogMapping[parentUid];
          if (m.variants[product.uid]) {
            contentIds.push(m.variants[product.uid]);
            mapped = true;
            break;
          }
        }
      }

      if (!mapped) {
        var parent = window.productCatalogMapping && window.productCatalogMapping[product.uid];
        if (parent) {
          var firstVariantUid = Object.keys(parent.variants)[0];
          var variantId = parent.variants[firstVariantUid];
          contentIds.push(variantId);
          mapped = true;
        }
      }

      if (!mapped) { contentIds.push(product.uid); fallbackUsed = true; }

      totalValue += parseFloat(product.price || 0) * parseInt(product.quantity || 1, 10);
      numItems += parseInt(product.quantity || 1, 10);
    });

    return {
      content_ids: contentIds,
      value: Number.isFinite(totalValue) ? Number(totalValue) : 0,
      num_items: numItems,
      fallback_used: fallbackUsed,
      raw: deepClone(window.tcart),
      order_id: (window.tcart && window.tcart.orderid) ? String(window.tcart.orderid) : null
    };
  }

  function persistSavedCart(cart){ try { localStorage.setItem(LOCAL_BACKUP_KEY, JSON.stringify({ ts: Date.now(), cart: cart })); } catch(e){} }
  function restoreSavedCart(maxAgeMs){
    try {
      var raw = localStorage.getItem(LOCAL_BACKUP_KEY);
      if (!raw) return null;
      var obj = JSON.parse(raw);
      if (!obj || !obj.cart) return null;
      if (maxAgeMs && Date.now() - (obj.ts || 0) > maxAgeMs) return null;
      return obj.cart;
    } catch(e){ return null; }
  }

  // ============================
  // FBQ INTERCEPTOR (v16.2)
  // ============================
  var _originalFbq = null;
  var _fbqReady = false;

  function installFbqInterceptor() {
    if (_fbqReady || typeof window.fbq === 'undefined') return;
    _fbqReady = true;
    _originalFbq = window.fbq;

    window.fbq = function() {
      var eventType = arguments[0];
      var eventName = arguments[1];
      var eventData = arguments[2];
      var eventOptions = arguments[3];

      if (eventType === 'track' && eventName === 'AddToCart') {
        var hasEventID = eventOptions && eventOptions.eventID;
        var hasContentIds = eventData && Array.isArray(eventData.content_ids) && eventData.content_ids.length > 0;

        if (!hasEventID && hasContentIds) {
          var tildaUid = eventData.content_ids[0];
          var externalId = window.tildaUidToExternalId[tildaUid];

          if (externalId) {
            var correctedData = deepClone(eventData);
            correctedData.content_ids = [externalId];
            var correctedOptions = { eventID: 'atc_' + externalId + '_' + Date.now() };

            try {
              console.log('ðŸ”§ v16.2 Ð˜Ð¡ÐŸÐ ÐÐ’Ð›Ð•ÐÐ˜Ð• AddToCart:', {
                from: tildaUid + ' (Tilda UID)',
                to: externalId + ' (External ID)',
                eventID: correctedOptions.eventID
              });
            } catch(_){}

            return _originalFbq.call(this, eventType, eventName, correctedData, correctedOptions);
          }
          // External ID Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½ - Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÐ¼ Ð¾Ñ€Ð¸Ð³Ð¸Ð½Ð°Ð»
          try { console.warn('âš ï¸ v16.2: Tilda UID Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½, Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÑÑŽ Ð¾Ñ€Ð¸Ð³Ð¸Ð½Ð°Ð»:', tildaUid); } catch(_){}
        }
      }

      return _originalFbq.apply(this, arguments);
    };

    for (var prop in _originalFbq) {
      if (_originalFbq.hasOwnProperty(prop)) { window.fbq[prop] = _originalFbq[prop]; }
    }

    try { console.log('âœ… v16.2 FBQ Interceptor ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½'); } catch(_){}
  }

  var purchaseSent = false;
  function sendPurchaseEvent(cartData) {
    if (purchaseSent) return;
    if (!cartData || !Array.isArray(cartData.content_ids) || cartData.content_ids.length === 0) return;

    purchaseSent = true;
    var eventId = cartData.order_id ? ('purchase_' + cartData.order_id) : ('purchase_' + Date.now());

    fbq('track', 'Purchase', {
      content_ids: cartData.content_ids,
      content_type: 'product',
      value: Number(cartData.value || 0),
      currency: CURRENCY,
      num_items: Number(cartData.num_items || 0)
    }, { eventID: eventId });

    try { console.log('ðŸŽ‰ Purchase sent', { value: cartData.value, currency: CURRENCY, num_items: cartData.num_items, eventID: eventId, fallback_used: !!cartData.fallback_used }); } catch(_){}
  }

  function initMetaPixelEnhanced() {
    if (typeof fbq === 'undefined') { setTimeout(initMetaPixelEnhanced, 100); return; }

    // Ð£Ð¡Ð¢ÐÐÐÐ’Ð›Ð˜Ð’ÐÐ•Ðœ ÐŸÐ•Ð Ð•Ð¥Ð’ÐÐ¢Ð§Ð˜Ðš ÐŸÐ•Ð Ð’Ð«Ðœ Ð”Ð•Ð›ÐžÐœ!
    installFbqInterceptor();

    function initViewContent() {
      var productElement = document.querySelector('[data-product-gen-uid][data-product-uid]');
      if (productElement) {
        var productData = getProductData(productElement);
        if (productData) {
          fbq('track', 'ViewContent', {
            content_name: productData.content_name,
            content_ids: [productData.variant_id],
            content_type: 'product',
            value: Number(productData.value || 0),
            currency: CURRENCY
          });
        }

        var observer = new MutationObserver(function(mutations) {
          mutations.forEach(function(mutation) {
            if (mutation.type === 'attributes' && mutation.attributeName === 'data-product-uid') {
              var newProductData = getProductData(productElement);
              if (newProductData) {
                fbq('track', 'ViewContent', {
                  content_name: newProductData.content_name,
                  content_ids: [newProductData.variant_id],
                  content_type: 'product',
                  value: Number(newProductData.value || 0),
                  currency: CURRENCY
                });
              }
            }
          });
        });
        observer.observe(productElement, { attributes: true, attributeFilter: ['data-product-uid'] });
      }
    }
    if (document.readyState === 'loading') { document.addEventListener('DOMContentLoaded', initViewContent); } else { initViewContent(); }

    document.addEventListener('tstore-cart-add', function() {
      var productElement = document.querySelector('[data-product-gen-uid][data-product-uid]');
      var productData = getProductData(productElement);
      if (productData) {
        fbq('track', 'AddToCart', {
          content_name: productData.content_name,
          content_ids: [productData.variant_id],
          content_type: 'product',
          value: Number(productData.value || 0),
          currency: CURRENCY
        }, { eventID: 'atc_' + productData.variant_id + '_' + Date.now() });
      }
      var snap = snapshotCartFromTilda();
      if (snap.content_ids.length > 0) { window.savedCartForPurchase = snap; persistSavedCart(snap); }
    });

    document.addEventListener('click', function(e) {
      var button = e.target && e.target.closest('a[href*="cart"], button');
      if (!button) return;
      var buttonText = (button.textContent || '').trim().toLowerCase();
      if (buttonText.includes('warenkorb') || buttonText.includes('cart') || buttonText.includes('in den') ||
          buttonText.includes('dodaj') || buttonText.includes('kosz') || buttonText.includes('adaug') || buttonText.includes('coÈ™')) {
        setTimeout(function() {
          var productElement = document.querySelector('[data-product-gen-uid][data-product-uid]');
          var productData = getProductData(productElement);
          if (productData) {
            fbq('track', 'AddToCart', {
              content_name: productData.content_name,
              content_ids: [productData.variant_id],
              content_type: 'product',
              value: Number(productData.value || 0),
              currency: CURRENCY
            }, { eventID: 'atc_' + productData.variant_id + '_' + Date.now() });
          }
          var snap = snapshotCartFromTilda();
          if (snap.content_ids.length > 0) { window.savedCartForPurchase = snap; persistSavedCart(snap); }
        }, 300);
      }
    });

    var checkoutInitiated = false;
    var checkoutObserver = new MutationObserver(function(mutations) {
      mutations.forEach(function(mutation) {
        mutation.addedNodes && Array.prototype.forEach.call(mutation.addedNodes, function(node) {
          if (node.nodeType !== 1 || checkoutInitiated) return;
          var checkoutFormField = node.querySelector && node.querySelector('input[name="name"], input[name="email"], input[placeholder*="Name"], input[placeholder*="Email"], input[placeholder*="Nume"]');
          if (checkoutFormField) {
            checkoutInitiated = true;
            var cartData = snapshotCartFromTilda();
            if (cartData.content_ids.length > 0) {
              window.savedCartForPurchase = cartData; persistSavedCart(cartData);
              fbq('track', 'InitiateCheckout', {
                content_ids: cartData.content_ids,
                content_type: 'product',
                value: Number(cartData.value || 0),
                currency: CURRENCY,
                num_items: Number(cartData.num_items || 0)
              }, { eventID: 'ic_dom_' + Date.now() });
            }
          }
        });
      });
    });
    checkoutObserver.observe(document.body, { childList: true, subtree: true });

    document.addEventListener('click', function(e) {
      var goCheckout = e.target && e.target.closest(
        'a[href*="checkout"], a[href*="#order"], a[href*="tilda/cart"], ' +
        'button[name="t-order"], button[data-tilda-store="checkout"], ' +
        '.t-store__cartwin-prodamount-wrapper .t-btn, .t706__cartwin-prodamount-wrapper .t-btn'
      );
      if (!goCheckout) return;

      var snapNow = snapshotCartFromTilda();
      if (snapNow.content_ids.length > 0) { window.savedCartForPurchase = snapNow; persistSavedCart(snapNow); }

      setTimeout(function() {
        var data = window.savedCartForPurchase || restoreSavedCart(LOCAL_BACKUP_TTL_MS) || snapshotCartFromTilda();
        if (data && data.content_ids.length > 0) {
          fbq('track', 'InitiateCheckout', {
            content_ids: data.content_ids,
            content_type: 'product',
            value: Number(data.value || 0),
            currency: CURRENCY,
            num_items: Number(data.num_items || 0)
          }, { eventID: 'ic_click_' + Date.now() });
        }
      }, IC_CLICK_DELAY_MS);
    });

    document.addEventListener('submit', function(e) {
      var form = e.target;
      if (!form) return;

      var isCheckoutForm =
        form.matches('.t-store__checkout-form form, form[action*="/payment"], form[action*="tilda"], form[id*="form"], form[class*="form"]') ||
        !!form.querySelector('input[name="name"], input[name="email"], input[type="email"], input[name*="mail" i], input[name*="name" i]');

      if (!isCheckoutForm) return;

      var snap = snapshotCartFromTilda();
      if (snap.content_ids.length > 0) { window.savedCartForPurchase = snap; persistSavedCart(snap); }

      setTimeout(function() {
        if (purchaseSent) return;
        var data = window.savedCartForPurchase || restoreSavedCart(LOCAL_BACKUP_TTL_MS) || snapshotCartFromTilda();
        if (data && data.content_ids.length > 0) { sendPurchaseEvent(data); }
      }, PURCHASE_DELAY_MS);
    }, true);

    function trySendPurchase() {
      if (purchaseSent) return;
      var data = window.savedCartForPurchase || restoreSavedCart(LOCAL_BACKUP_TTL_MS) || snapshotCartFromTilda();
      if (data && data.content_ids.length > 0) { sendPurchaseEvent(data); }
    }
    document.addEventListener('tildaform:success', trySendPurchase, false);
    document.addEventListener('tildaform:aftersuccess', trySendPurchase, false);
    document.addEventListener('tstore-checkout-success', trySendPurchase, false);

    if (document.querySelector('.t-store__thankyoupage')) {
      setTimeout(trySendPurchase, 1200);
    }

    document.addEventListener('tcart_change', function() {
      var snap2 = snapshotCartFromTilda();
      if (snap2.content_ids.length > 0) { window.savedCartForPurchase = snap2; persistSavedCart(snap2); }
    });

    try { console.log('ðŸ”§ Meta Pixel v16.2 (DE) Ð³Ð¾Ñ‚Ð¾Ð². Ð’Ð°Ð»ÑŽÑ‚Ð°:', CURRENCY); } catch(_){}
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function(){ waitForFbq(initMetaPixelEnhanced); });
  } else {
    waitForFbq(initMetaPixelEnhanced);
  }
})();
</script>


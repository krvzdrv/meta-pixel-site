<script>
/************************************************
 * ðŸŸ¦ META PIXEL + FACEBOOK/INSTAGRAM SHOPS
 * v16.2 â€” FBQ INTERCEPTOR: Fix Tilda's wrong content_ids
 * 
 * ÐšÐ Ð˜Ð¢Ð˜Ð§Ð•Ð¡ÐšÐžÐ• Ð˜Ð¡ÐŸÐ ÐÐ’Ð›Ð•ÐÐ˜Ð•:
 * Tilda Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÑ‚ AddToCart Ñ Tilda UID Ð²Ð¼ÐµÑÑ‚Ð¾ External ID
 * Tilda ÐÐ• Ð³ÐµÐ½ÐµÑ€Ð¸Ñ€ÑƒÐµÑ‚ ÑÐ¾Ð±Ñ‹Ñ‚Ð¸Ðµ tstore-cart-add
 * Ð ÐµÑˆÐµÐ½Ð¸Ðµ: ÐŸÐµÑ€ÐµÑ…Ð²Ð°Ñ‚Ñ‹Ð²Ð°ÐµÐ¼ fbq Ð¸ Ð¸ÑÐ¿Ñ€Ð°Ð²Ð»ÑÐµÐ¼ content_ids Ð½Ð° Ð»ÐµÑ‚Ñƒ
 * 
 * Ð¡Ð°Ð¹Ñ‚: alumineu.pl | Ð’Ð°Ð»ÑŽÑ‚Ð°: PLN
 * Pixel ID Ð±ÐµÑ€Ñ‘Ñ‚ÑÑ Ð¸Ð· Tilda â†’ Site Settings â†’ Analytics â†’ Facebook Pixel
 * 
 * ÐŸÐžÐ›ÐÐ«Ð™ MAPPING: 65 parent Ñ‚Ð¾Ð²Ð°Ñ€Ð¾Ð², 109 Ð²Ð°Ñ€Ð¸Ð°Ð½Ñ‚Ð¾Ð²
 ************************************************/
(function(){'use strict';
  var CURRENCY='PLN';
  var LOCAL_BACKUP_KEY='savedCartForPurchase_v1';
  var LOCAL_BACKUP_TTL_MS=30*60*1000;
  var PURCHASE_DELAY_MS=2500;
  var IC_CLICK_DELAY_MS=500;

  // ============================
  // PRODUCT CATALOG MAPPING
  // 65 parent Ñ‚Ð¾Ð²Ð°Ñ€Ð¾Ð², 109 Ð²Ð°Ñ€Ð¸Ð°Ð½Ñ‚Ð¾Ð²
  // ============================
  window.productCatalogMapping = {
    "839319337232": {
        "group": "invisia_x201",
        "variants": {
            "190792308312": "oo9OjTbNgZ8SJAWgghj610"
        }
    },
    "507661787472": {
        "group": "lightra_x030",
        "variants": {
            "500336886312": "Rv6KF1WLiPamjAv2BaZge3"
        }
    },
    "643951758772": {
        "group": "lightra_x015",
        "variants": {
            "730235871282": "olHJtrUhhLVDB5FN2Is6G0"
        }
    },
    "291145398992": {
        "group": "lightra_x030_s",
        "variants": {
            "928673577412": "MzeeWUC0gyE9JJJLbz34v3"
        }
    },
    "658200666082": {
        "group": "lightra_x050",
        "variants": {
            "493470832492": "wDQZybWWgNkn2Zq49zPi30"
        }
    },
    "225827805212": {
        "group": "curtina_x402",
        "variants": {
            "470155476702": "e9yQf8rDjzi3XjGnnx3Iw3",
            "549414479522": "DKTDmwA2icCZL2vSUjXum3",
            "858880037952": "vdjAWIcdhHNfZhVE150J92",
            "677445128382": "eePmEHIghXucCCjWcE2zy3"
        }
    },
    "217015100692": {
        "group": "curtina_x403",
        "variants": {
            "947995799482": "yUubMVw1hqQAZdBztKRgZ2",
            "172085818052": "hSqFGvnTjaggVAymnovmh0",
            "280441303392": "smfA9ADrg9P4AffHsiprN2",
            "706721254362": "Hxf-n56DhLa95Jq8oTmSb3",
            "790798238972": "i3hGepcZiU3L8JqEJ2rtV0",
            "683960763922": "34WwfpBUjupvpuPa3EpLr3",
            "656602599672": "jx2sQ0lhiTZsQVWNF9X2z0"
        }
    },
    "286691236472": {
        "group": "curtina_x405",
        "variants": {
            "578757699002": "zRy2mTY3io-ReCRagT1MI2",
            "400677780532": "9YYv8DXkjKpGTTDe3j99Y3",
            "353195082562": "M7K8jSGug5rmTO1txLm922",
            "352183116882": "Rid7eYeaihDEYyuGmwIm10",
            "207813980922": "hRYJaVIahB4Jg-O10ZpbV0",
            "767458116892": "QYtmUePthsfmVcpZ7LaHB2"
        }
    },
    "944430522512": {
        "group": "floatia_x301",
        "variants": {
            "647131319142": "jzysdA0nhEDukcRfamitz0"
        }
    },
    "457317933972": {
        "group": "floatia_x302",
        "variants": {
            "908822240152": "IxT7oD8zhIbrnn2LbGw2D0",
            "460694307962": "Y7mho3jShobDY2hUqkXX83",
            "682226449002": "fxcs1s4Sg4i9usohMYyp11"
        }
    },
    "866589002222": {
        "group": "invisia_x202",
        "variants": {
            "187163923112": "DJNjCqquhcS8YMhhFUUT-3"
        }
    },
    "214321009432": {
        "group": "invisia_x205",
        "variants": {
            "930494652722": "lFPD6yXiiis-LJnoPBaa91"
        }
    },
    "637058175962": {
        "group": "invisia_x204",
        "variants": {
            "219418945412": "zA59TVMAiMOOTZf15BUvl2"
        }
    },
    "863595866502": {
        "group": "inserta_y015_f",
        "variants": {
            "205632574742": "CWpGaKdlgRQIwS9TWZI6n0"
        }
    },
    "988132487472": {
        "group": "inserta_y030",
        "variants": {
            "167761625542": "MP9kMK6mg9LT--ZPdvSbb1"
        }
    },
    "979499294302": {
        "group": "classix_x140",
        "variants": {
            "956057347402": "V3cnnvOSiRXwOxWDjbAgp3"
        }
    },
    "270251792782": {
        "group": "contura_x601",
        "variants": {
            "363135129882": "uOmKNKiKhPZzh4UNscvrM3"
        }
    },
    "103976771442": {
        "group": "anglova_y401",
        "variants": {
            "278394663382": "5Iae0Kl7jHu3J80n7k6Nu3"
        }
    },
    "377930125792": {
        "group": "inserta_y008",
        "variants": {
            "544791563252": "5A33vrjxg2INi6FdYvYHV1",
            "530940509082": "Zm1YLzGFjDyJzl5BQ2AZK2"
        }
    },
    "366051110192": {
        "group": "inserta_y015",
        "variants": {
            "657090068192": "jWf3YVZMj28oz3Vn9Ruwa1"
        }
    },
    "100136262512": {
        "group": "diffusy_y114",
        "variants": {
            "603162593602": "SVjKGGnNhIO8Ovbe-z0yF3"
        }
    },
    "155678066152": {
        "group": "diffusy_y130",
        "variants": {
            "799634883332": "5ET97eXngrRKDRbIJ4YhN2",
            "427448362392": "yfcIPkXYi7hGeHi9sRjg51"
        }
    },
    "299840035862": {
        "group": "diffusy_y150",
        "variants": {
            "333939180002": "Z0jQpgcsgfNvDPq3zycpi1"
        }
    },
    "626383725252": {
        "group": "endcapp_y205",
        "variants": {
            "472351853372": "0tjwIdlUikOX0Ujz8iz0g0",
            "692395679122": "s3hlPBkThtLs9b-VgS5-72"
        }
    },
    "780735768642": {
        "group": "endcapp_y201",
        "variants": {
            "239277149292": "h5ANH4hyhaQ0ahlbaV9nf3"
        }
    },
    "427944429862": {
        "group": "endcapp_y206",
        "variants": {
            "210946065632": "tPFY8g6HhI3goBhXwFAdR2",
            "430276725522": "qbmrWdNBhQrZ9Ppq1rO-N2"
        }
    },
    "303380045822": {
        "group": "endcapp_y202",
        "variants": {
            "698448881602": "9wJD0JkkglPzVeK5rRpif0"
        }
    },
    "985794228902": {
        "group": "hl8u8snpgyZDAeA3bi6V",
        "variants": {
            "506981488432": "cLEZP2Ssga1osq6fjuzBl3"
        }
    },
    "539064459322": {
        "group": "endcapp_y203",
        "variants": {
            "136351521022": "gjxLSmpZiFX6ORefsKjSS1"
        }
    },
    "601215188112": {
        "group": "endcapp_y204",
        "variants": {
            "904018718232": "mY3nP58iiQbbhe6E8ifuq2"
        }
    },
    "186520996002": {
        "group": "curtina_x406",
        "variants": {
            "465636530832": "vdRmfjJniS9p1gOygMbDs0",
            "713028260252": "08Gs75cLiwndvRDfwZZkQ2"
        }
    },
    "588338924642": {
        "group": "curtina_x407",
        "variants": {
            "310401271012": "cJyPtbDhhRAmihZrojWDn0",
            "702501896712": "gtIKBLtJghv4WzA42yxPP1"
        }
    },
    "455755633812": {
        "group": "invisia_x206",
        "variants": {
            "807119127272": "EGXmtijjgeQdvXQSqdLGi3"
        }
    },
    "193347392862": {
        "group": "invisia_x207",
        "variants": {
            "564597798492": "YZTju3ikgOF1-Sj6ktK6e2"
        }
    },
    "850354166152": {
        "group": "invisia_x208",
        "variants": {
            "704856397272": "eyVbkQihgGQtYR5EF0P4w0"
        }
    },
    "318348125602": {
        "group": "invisia_x209",
        "variants": {
            "464804245532": "cTT1GGAZj76alVXu4vaAe1",
            "920286588882": "EeRJkcybhq5xX9vhB-xzv3"
        }
    },
    "645467917622": {
        "group": "floatia_x303",
        "variants": {
            "978567868692": "VL9D-5xNhHiRwdOhXxgjl3",
            "562270940852": "xO7PAABriJTHSKVNGiuYl3",
            "756302229732": "MyI2v2JMhnRtUrh6H58nz0"
        }
    },
    "424100714092": {
        "group": "stratos_x701",
        "variants": {
            "542073945932": "mCMAr4yQhDaPX-LNJ5RD73"
        }
    },
    "901383924132": {
        "group": "classix_x130",
        "variants": {
            "567404048592": "lxFpGXGnhGh-TPEwCLiEt2"
        }
    },
    "512931150072": {
        "group": "classix_x101",
        "variants": {
            "271725217432": "rtBsri0AgIfzRs45xlYEo3"
        }
    },
    "637088875452": {
        "group": "stratos_x704",
        "variants": {
            "324744800482": "TTCe8rd4gfNWGALqZZ6XQ1",
            "226755699832": "5rGDU6PghnaCaAB4hbK363"
        }
    },
    "877708952812": {
        "group": "stratos_x703",
        "variants": {
            "822678424062": "9DTMhoqug8m-s5umlvoUH2"
        }
    },
    "866804789572": {
        "group": "stratos_x702",
        "variants": {
            "348189936572": "A8KXwZGog4GTrG3uTcqe72"
        }
    },
    "727940440772": {
        "group": "bandura_x801",
        "variants": {
            "828448694242": "Ld9AkcuQi0qA19EQUN-hA0"
        }
    },
    "784147017562": {
        "group": "tZ8s8oIOAFvt1cMJXzxT",
        "variants": {
            "728119314532": "DM8mxViMehuUjZTlVoZV",
            "744637319072": "sxyC62IKtMsA3ZL4PKj7"
        }
    },
    "349021022592": {
        "group": "nBs1h8dlk1ROtHyOGUs2",
        "variants": {
            "527435460662": "aCHzx02I7ptPRt1ILGl7",
            "778775009522": "yIgRSAaa7xFhoPfXou5K"
        }
    },
    "285934709692": {
        "group": "decorra",
        "variants": {
            "169077060902": "ergHrlZUg2QIND1V8IhSJ2",
            "183762869242": "Uol4AUi6iIvTMzs54EO9j2",
            "286760936572": "lp4e5bsYjDqziPV39cnuC2",
            "142180096742": "bmi8XCqTjEWJdGyaSuIyc0",
            "177168491372": "1DXQpiEKjE3GouFX6fQLj1",
            "294756901722": "Mi1z6scziBgnL27xWxmwT2"
        }
    },
    "427006227442": {
        "group": "aerooom",
        "variants": {
            "663434506042": "67Bbx0xngULuV9UzemHTF3",
            "348613847532": "jvZowSDbjriTyuZ4gKOP73",
            "196710851972": "QUUROkmnjacZooCUHKa9k1"
        }
    },
    "305747026432": {
        "group": "diffusy_y134",
        "variants": {
            "796975875442": "OKOeFss5i43IMv6ZjYcRM3"
        }
    },
    "425407383692": {
        "group": "aerroll_z",
        "variants": {
            "949232860922": "KKdTYiB5ilH9EwahKpKah0",
            "847063302852": "ARWzP670jnmjJZpK5JsEU1",
            "273315715262": "xP5AwirJg8GaTPI5ZRvbx2"
        }
    },
    "279963449642": {
        "group": "tissure_z405",
        "variants": {
            "427322588352": "ASFuUxWDgOBWCHN5ODymF1",
            "907892131702": "JahvyJtvVXisybeMRX42"
        }
    },
    "702075123972": {
        "group": "unitexa_z701",
        "variants": {
            "929118351672": "SQKcK9vigikWY0Agh6ZSX0",
            "623092361922": "zSQvbSNEiHa6S1KQEwaCY2"
        }
    },
    "464689655122": {
        "group": "lumnova_z008",
        "variants": {
            "243760267412": "eSviEBM8guhlvQefni07r1"
        }
    },
    "340968640132": {
        "group": "tissure_z401",
        "variants": {
            "172769532402": "1BcJh8vVg8aapGEcAUDrg1",
            "202776240732": "hymJQJJTjY-YeQVF1giqT1"
        }
    },
    "589074152912": {
        "group": "Kb9h3nXavOohfs52Bgke",
        "variants": {
            "236752794272": "rvXYsZbhkezxEgy03xpZ"
        }
    },
    "942768878232": {
        "group": "lamplix_x930",
        "variants": {
            "207063938512": "63SkQfPpjSYcEKuuMh-YG2"
        }
    },
    "591857318792": {
        "group": "lamplix_x950",
        "variants": {
            "689188872022": "Xo7o90pXhmhKf1FmlwptL2"
        }
    },
    "738455398342": {
        "group": "voltiva_z501",
        "variants": {
            "263103690522": "0WyuTzYWjCQp6Fj0LuztH0"
        }
    },
    "103850078252": {
        "group": "curtina_x405_m",
        "variants": {
            "479658278692": "iSRbWSLtitojIsPO0sI9x2",
            "116125562342": "gA28ToLCggK3W8YPSsFkT1",
            "339464740812": "CkVvKhJbiGhhK2anvHdB33",
            "223173096572": "PIsjk6JZiDyyFLIyu2lyU0"
        }
    },
    "653704983262": {
        "group": "floatia_x304",
        "variants": {
            "325345639572": "OGuLhFuVjSlwHsBusU5Sf1"
        }
    },
    "378838179802": {
        "group": "curtina_x408",
        "variants": {
            "910838572902": "FWceQ5ETivN6fBl0i-tWJ2"
        }
    },
    "351390516332": {
        "group": "curtina_x409",
        "variants": {
            "697706454502": "LhsJi728gSt1-qEKriOWU2"
        }
    },
    "101371876602": {
        "group": "curtina_x410",
        "variants": {
            "129055913692": "JLVFDRdrgtcM9IORQDzXv0"
        }
    },
    "199858223452": {
        "group": "curtina_x411",
        "variants": {
            "930688697052": "KmK1hPPBihH4KDyWNRaPo0"
        }
    },
    "143334734952": {
        "group": "curtina_x404",
        "variants": {
            "811654953612": "ryMNNy0Vjq1ciFgP2gUaK3",
            "814666177362": "6UZy5OEYgiU2cDd92z2R00"
        }
    }
};

  // ============================
  // REVERSE MAPPING (Tilda UID â†’ External ID)
  // Ð”Ð»Ñ Ð±Ñ‹ÑÑ‚Ñ€Ð¾Ð³Ð¾ Ð¿Ð¾Ð¸ÑÐºÐ° External ID Ð¿Ð¾ Tilda UID
  // ============================
  window.tildaUidToExternalId = {};
  for (var parentUid in window.productCatalogMapping) {
    var mapping = window.productCatalogMapping[parentUid];
    for (var variantUid in mapping.variants) {
      window.tildaUidToExternalId[variantUid] = mapping.variants[variantUid];
    }
  }

  // ============================
  // HELPERS
  // ============================
  function deepClone(obj){ try { return JSON.parse(JSON.stringify(obj)); } catch(_) { return null; } }
  function waitForFbq(ready){ if (typeof window.fbq === 'function') return ready(); setTimeout(function(){ waitForFbq(ready); }, 100); }

  function getProductData(productElement) {
    if (!productElement) return null;
    var parentUid = productElement.getAttribute('data-product-gen-uid');
    var variantUid = productElement.getAttribute('data-product-uid');
    if (!parentUid || !variantUid) return null;

    var productMapping = window.productCatalogMapping[parentUid];
    if (!productMapping) return null;

    var variantId = productMapping.variants[variantUid];
    var fallbackUsed = false;
    if (!variantId) { variantId = productMapping.group; fallbackUsed = true; }

    var titleElement = productElement.querySelector('.js-product-name, .t-name, .t-store__card__title');
    var priceElement = productElement.querySelector('.js-product-price, .t-store__card__price-value');

    return {
      variant_id: variantId,
      content_name: titleElement ? titleElement.textContent.trim() : 'Product',
      value: priceElement ? parseFloat(String(priceElement.textContent).replace(/[^\d.,]/g, '').replace(',', '.')) : 0,
      fallback_used: fallbackUsed
    };
  }

  function snapshotCartFromTilda() {
    var contentIds = [], totalValue = 0, numItems = 0, fallbackUsed = false;

    if (!window.tcart || !Array.isArray(window.tcart.products) || window.tcart.products.length === 0) {
      return { content_ids: [], value: 0, num_items: 0, fallback_used: false, raw: null, order_id: null };
    }

    window.tcart.products.forEach(function(product) {
      var mapped = false;

      if (window.productCatalogMapping) {
        for (var parentUid in window.productCatalogMapping) {
          var m = window.productCatalogMapping[parentUid];
          if (m.variants[product.uid]) {
            contentIds.push(m.variants[product.uid]);
            mapped = true;
            break;
          }
        }
      }

      if (!mapped) {
        var parent = window.productCatalogMapping && window.productCatalogMapping[product.uid];
        if (parent) {
          var firstVariantUid = Object.keys(parent.variants)[0];
          var variantId = parent.variants[firstVariantUid];
          contentIds.push(variantId);
          mapped = true;
        }
      }

      if (!mapped) { contentIds.push(product.uid); fallbackUsed = true; }

      totalValue += parseFloat(product.price || 0) * parseInt(product.quantity || 1, 10);
      numItems += parseInt(product.quantity || 1, 10);
    });

    return {
      content_ids: contentIds,
      value: Number.isFinite(totalValue) ? Number(totalValue) : 0,
      num_items: numItems,
      fallback_used: fallbackUsed,
      raw: deepClone(window.tcart),
      order_id: (window.tcart && window.tcart.orderid) ? String(window.tcart.orderid) : null
    };
  }

  function persistSavedCart(cart){ try { localStorage.setItem(LOCAL_BACKUP_KEY, JSON.stringify({ ts: Date.now(), cart: cart })); } catch(e){} }
  function restoreSavedCart(maxAgeMs){
    try {
      var raw = localStorage.getItem(LOCAL_BACKUP_KEY);
      if (!raw) return null;
      var obj = JSON.parse(raw);
      if (!obj || !obj.cart) return null;
      if (maxAgeMs && Date.now() - (obj.ts || 0) > maxAgeMs) return null;
      return obj.cart;
    } catch(e){ return null; }
  }

  // ============================
  // FBQ INTERCEPTOR (v16.2)
  // ÐŸÐµÑ€ÐµÑ…Ð²Ð°Ñ‚Ñ‹Ð²Ð°ÐµÑ‚ Ð²Ñ‹Ð·Ð¾Ð²Ñ‹ fbq Ð¾Ñ‚ Tilda Ð¸ Ð¸ÑÐ¿Ñ€Ð°Ð²Ð»ÑÐµÑ‚ Ð½ÐµÐ¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ñ‹Ðµ content_ids
  // ============================
  var _originalFbq = null;
  var _fbqReady = false;

  function installFbqInterceptor() {
    if (_fbqReady || typeof window.fbq === 'undefined') return;
    _fbqReady = true;
    _originalFbq = window.fbq;

    window.fbq = function() {
      var eventType = arguments[0];
      var eventName = arguments[1];
      var eventData = arguments[2];
      var eventOptions = arguments[3];

      // ÐŸÐ•Ð Ð•Ð¥Ð’ÐÐ¢ AddToCart Ð¾Ñ‚ Tilda
      if (eventType === 'track' && eventName === 'AddToCart') {
        var hasEventID = eventOptions && eventOptions.eventID;
        var hasContentIds = eventData && Array.isArray(eventData.content_ids) && eventData.content_ids.length > 0;

        // Ð•ÑÐ»Ð¸ Ð½ÐµÑ‚ eventID - ÑÑ‚Ð¾ Ð¾Ñ‚ Tilda, Ð½ÑƒÐ¶Ð½Ð¾ Ð¸ÑÐ¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒ!
        if (!hasEventID && hasContentIds) {
          var tildaUid = eventData.content_ids[0];
          var externalId = window.tildaUidToExternalId[tildaUid];

          if (externalId) {
            // Ð˜Ð¡ÐŸÐ ÐÐ’Ð›Ð¯Ð•Ðœ: Tilda UID â†’ External ID
            var correctedData = deepClone(eventData);
            correctedData.content_ids = [externalId];

            // Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ eventID
            var correctedOptions = {
              eventID: 'atc_' + externalId + '_' + Date.now()
            };

            try {
              console.log('ðŸ”§ v16.2 Ð˜Ð¡ÐŸÐ ÐÐ’Ð›Ð•ÐÐ˜Ð• AddToCart:', {
                from: tildaUid + ' (Tilda UID)',
                to: externalId + ' (External ID)',
                eventID: correctedOptions.eventID
              });
            } catch(_){}

            // ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÐ¼ Ð˜Ð¡ÐŸÐ ÐÐ’Ð›Ð•ÐÐÐžÐ• ÑÐ¾Ð±Ñ‹Ñ‚Ð¸Ðµ
            return _originalFbq.call(this, eventType, eventName, correctedData, correctedOptions);
          } else {
            // External ID Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½ - Ð»Ð¾Ð³Ð¸Ñ€ÑƒÐµÐ¼ Ð¸ Ð¿Ñ€Ð¾Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð¾Ñ€Ð¸Ð³Ð¸Ð½Ð°Ð»
            try {
              console.warn('âš ï¸ v16.2: Tilda UID Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½ Ð² mapping:', tildaUid);
            } catch(_){}
          }
        }
      }

      // Ð’ÑÐµ Ð¾ÑÑ‚Ð°Ð»ÑŒÐ½Ñ‹Ðµ ÑÐ¾Ð±Ñ‹Ñ‚Ð¸Ñ - Ð¿Ñ€Ð¾Ð¿ÑƒÑÐºÐ°ÐµÐ¼ ÐºÐ°Ðº ÐµÑÑ‚ÑŒ
      return _originalFbq.apply(this, arguments);
    };

    // ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ ÑÐ²Ð¾Ð¹ÑÑ‚Ð²Ð°
    for (var prop in _originalFbq) {
      if (_originalFbq.hasOwnProperty(prop)) {
        window.fbq[prop] = _originalFbq[prop];
      }
    }

    try { console.log('âœ… v16.2 FBQ Interceptor ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½'); } catch(_){}
  }

  // ============================
  // CORE SENDER
  // ============================
  var purchaseSent = false;
  function sendPurchaseEvent(cartData) {
    if (purchaseSent) return;
    if (!cartData || !Array.isArray(cartData.content_ids) || cartData.content_ids.length === 0) return;

    purchaseSent = true;
    var eventId = cartData.order_id ? ('purchase_' + cartData.order_id) : ('purchase_' + Date.now());

    fbq('track', 'Purchase', {
      content_ids: cartData.content_ids,
      content_type: 'product',
      value: Number(cartData.value || 0),
      currency: CURRENCY,
      num_items: Number(cartData.num_items || 0)
    }, { eventID: eventId });

    try { console.log('ðŸŽ‰ Purchase sent', { value: cartData.value, currency: CURRENCY, num_items: cartData.num_items, eventID: eventId, fallback_used: !!cartData.fallback_used }); } catch(_){}
  }

  // ============================
  // MAIN INIT
  // ============================
  function initMetaPixelEnhanced() {
    if (typeof fbq === 'undefined') { setTimeout(initMetaPixelEnhanced, 100); return; }

    // Ð£Ð¡Ð¢ÐÐÐÐ’Ð›Ð˜Ð’ÐÐ•Ðœ ÐŸÐ•Ð Ð•Ð¥Ð’ÐÐ¢Ð§Ð˜Ðš ÐŸÐ•Ð Ð’Ð«Ðœ Ð”Ð•Ð›ÐžÐœ!
    installFbqInterceptor();

    // 1) ViewContent + ÑÐ¼ÐµÐ½Ð° Ð²Ð°Ñ€Ð¸Ð°Ð½Ñ‚Ð°
    function initViewContent() {
      var productElement = document.querySelector('[data-product-gen-uid][data-product-uid]');
      if (productElement) {
        var productData = getProductData(productElement);
        if (productData) {
          fbq('track', 'ViewContent', {
            content_name: productData.content_name,
            content_ids: [productData.variant_id],
            content_type: 'product',
            value: Number(productData.value || 0),
            currency: CURRENCY
          });
        }

        var observer = new MutationObserver(function(mutations) {
          mutations.forEach(function(mutation) {
            if (mutation.type === 'attributes' && mutation.attributeName === 'data-product-uid') {
              var newProductData = getProductData(productElement);
              if (newProductData) {
                fbq('track', 'ViewContent', {
                  content_name: newProductData.content_name,
                  content_ids: [newProductData.variant_id],
                  content_type: 'product',
                  value: Number(newProductData.value || 0),
                  currency: CURRENCY
                });
              }
            }
          });
        });
        observer.observe(productElement, { attributes: true, attributeFilter: ['data-product-uid'] });
      }
    }
    if (document.readyState === 'loading') { document.addEventListener('DOMContentLoaded', initViewContent); } else { initViewContent(); }

    // 2) AddToCart
    document.addEventListener('tstore-cart-add', function() {
      var productElement = document.querySelector('[data-product-gen-uid][data-product-uid]');
      var productData = getProductData(productElement);
      if (productData) {
        fbq('track', 'AddToCart', {
          content_name: productData.content_name,
          content_ids: [productData.variant_id],
          content_type: 'product',
          value: Number(productData.value || 0),
          currency: CURRENCY
        }, { eventID: 'atc_' + productData.variant_id + '_' + Date.now() });
      }
      var snap = snapshotCartFromTilda();
      if (snap.content_ids.length > 0) { window.savedCartForPurchase = snap; persistSavedCart(snap); }
    });

    document.addEventListener('click', function(e) {
      var button = e.target && e.target.closest('a[href*="cart"], button');
      if (!button) return;
      var buttonText = (button.textContent || '').trim().toLowerCase();
      if (buttonText.includes('dodaj') || buttonText.includes('kosz') || buttonText.includes('cart') ||
          buttonText.includes('warenkorb') || buttonText.includes('coÈ™') || buttonText.includes('cos')) {
        setTimeout(function() {
          var productElement = document.querySelector('[data-product-gen-uid][data-product-uid]');
          var productData = getProductData(productElement);
          if (productData) {
            fbq('track', 'AddToCart', {
              content_name: productData.content_name,
              content_ids: [productData.variant_id],
              content_type: 'product',
              value: Number(productData.value || 0),
              currency: CURRENCY
            }, { eventID: 'atc_' + productData.variant_id + '_' + Date.now() });
          }
          var snap = snapshotCartFromTilda();
          if (snap.content_ids.length > 0) { window.savedCartForPurchase = snap; persistSavedCart(snap); }
        }, 300);
      }
    });

    // 3) InitiateCheckout (DOM)
    var checkoutInitiated = false;
    var checkoutObserver = new MutationObserver(function(mutations) {
      mutations.forEach(function(mutation) {
        mutation.addedNodes && Array.prototype.forEach.call(mutation.addedNodes, function(node) {
          if (node.nodeType !== 1 || checkoutInitiated) return;
          var checkoutFormField = node.querySelector && node.querySelector('input[name="name"], input[name="email"], input[placeholder*="Name"], input[placeholder*="Email"]');
          if (checkoutFormField) {
            checkoutInitiated = true;
            var cartData = snapshotCartFromTilda();
            if (cartData.content_ids.length > 0) {
              window.savedCartForPurchase = cartData; persistSavedCart(cartData);
              fbq('track', 'InitiateCheckout', {
                content_ids: cartData.content_ids,
                content_type: 'product',
                value: Number(cartData.value || 0),
                currency: CURRENCY,
                num_items: Number(cartData.num_items || 0)
              }, { eventID: 'ic_dom_' + Date.now() });
            }
          }
        });
      });
    });
    checkoutObserver.observe(document.body, { childList: true, subtree: true });

    // 3b) InitiateCheckout (ÐºÐ»Ð¸Ðº)
    document.addEventListener('click', function(e) {
      var goCheckout = e.target && e.target.closest(
        'a[href*="checkout"], a[href*="#order"], a[href*="tilda/cart"], ' +
        'button[name="t-order"], button[data-tilda-store="checkout"], ' +
        '.t-store__cartwin-prodamount-wrapper .t-btn, .t706__cartwin-prodamount-wrapper .t-btn'
      );
      if (!goCheckout) return;

      var snapNow = snapshotCartFromTilda();
      if (snapNow.content_ids.length > 0) { window.savedCartForPurchase = snapNow; persistSavedCart(snapNow); }

      setTimeout(function() {
        var data = window.savedCartForPurchase || restoreSavedCart(LOCAL_BACKUP_TTL_MS) || snapshotCartFromTilda();
        if (data && data.content_ids.length > 0) {
          fbq('track', 'InitiateCheckout', {
            content_ids: data.content_ids,
            content_type: 'product',
            value: Number(data.value || 0),
            currency: CURRENCY,
            num_items: Number(data.num_items || 0)
          }, { eventID: 'ic_click_' + Date.now() });
        }
      }, IC_CLICK_DELAY_MS);
    });

    // 4) Purchase
    document.addEventListener('submit', function(e) {
      var form = e.target;
      if (!form) return;

      var isCheckoutForm =
        form.matches('.t-store__checkout-form form, form[action*="/payment"], form[action*="tilda"], form[id*="form"], form[class*="form"]') ||
        !!form.querySelector('input[name="name"], input[name="email"], input[type="email"], input[name*="mail" i], input[name*="name" i]');

      if (!isCheckoutForm) return;

      var snap = snapshotCartFromTilda();
      if (snap.content_ids.length > 0) { window.savedCartForPurchase = snap; persistSavedCart(snap); }

      setTimeout(function() {
        if (purchaseSent) return;
        var data = window.savedCartForPurchase || restoreSavedCart(LOCAL_BACKUP_TTL_MS) || snapshotCartFromTilda();
        if (data && data.content_ids.length > 0) { sendPurchaseEvent(data); }
      }, PURCHASE_DELAY_MS);
    }, true);

    function trySendPurchase() {
      if (purchaseSent) return;
      var data = window.savedCartForPurchase || restoreSavedCart(LOCAL_BACKUP_TTL_MS) || snapshotCartFromTilda();
      if (data && data.content_ids.length > 0) { sendPurchaseEvent(data); }
    }
    document.addEventListener('tildaform:success', trySendPurchase, false);
    document.addEventListener('tildaform:aftersuccess', trySendPurchase, false);
    document.addEventListener('tstore-checkout-success', trySendPurchase, false);

    if (document.querySelector('.t-store__thankyoupage')) {
      setTimeout(trySendPurchase, 1200);
    }

    document.addEventListener('tcart_change', function() {
      var snap2 = snapshotCartFromTilda();
      if (snap2.content_ids.length > 0) { window.savedCartForPurchase = snap2; persistSavedCart(snap2); }
    });

    try { console.log('ðŸ”§ Meta Pixel v16.2 (PL) Ð³Ð¾Ñ‚Ð¾Ð². Ð’Ð°Ð»ÑŽÑ‚Ð°:', CURRENCY); } catch(_){}
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function(){ waitForFbq(initMetaPixelEnhanced); });
  } else {
    waitForFbq(initMetaPixelEnhanced);
  }
})();
</script>
